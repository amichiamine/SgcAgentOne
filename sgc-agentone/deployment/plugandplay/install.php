<?php
/**
 * SGC-AgentOne Plug & Play - Script d'installation automatique universelle
 * Compatible: H√©bergement web, XAMPP, LAMP, MAMP
 * Lance depuis le dossier sgc-agentone/ pour configurer l'environnement
 */

// D√©tection intelligente de l'environnement
function detectInstallEnvironment() {
    $env = [
        'script_dir' => dirname(__FILE__),
        'script_name' => $_SERVER['SCRIPT_NAME'],
        'server_name' => $_SERVER['SERVER_NAME'] ?? 'localhost',
        'is_localhost' => false,
        'install_path' => '',
        'base_url' => ''
    ];
    
    // D√©tection localhost
    if (in_array($env['server_name'], ['localhost', '127.0.0.1']) || 
        strpos($env['server_name'], 'localhost') !== false) {
        $env['is_localhost'] = true;
    }
    
    // Calcul du chemin d'installation selon la position du script
    if (basename($env['script_dir']) === 'plugandplay') {
        // Script dans deployment/plugandplay/ - installer dans sgc-agentone/
        $env['install_path'] = dirname($env['script_dir'], 2);
        $env['base_url'] = dirname($_SERVER['SCRIPT_NAME'], 3);
    } else {
        // Script copi√© ailleurs - installer dans le dossier courant
        $env['install_path'] = $env['script_dir'];
        $env['base_url'] = dirname($_SERVER['SCRIPT_NAME']);
    }
    
    return $env;
}

// Configuration dynamique
$env = detectInstallEnvironment();
$installPath = $env['install_path'];

echo "üîå <strong>SGC-AgentOne Plug & Play - Installation Automatique</strong><br><br>";
echo "<div style='background: #e8f4fd; padding: 10px; border-left: 4px solid #2196F3; margin-bottom: 15px;'>";
echo "‚ú® <strong>Compatible avec tous les environnements :</strong><br>";
echo "üåê H√©bergement web mutualis√© ‚Ä¢ üñ•Ô∏è XAMPP ‚Ä¢ üêß LAMP ‚Ä¢ üçé MAMP";
echo "</div>";

// V√©rification de l'environnement
function checkEnvironment() {
    $checks = [];
    
    // V√©rification PHP
    $checks[] = [
        'test' => 'PHP Version >= 7.4',
        'result' => version_compare(PHP_VERSION, '7.4.0', '>='),
        'details' => 'Version actuelle: ' . PHP_VERSION
    ];
    
    // V√©rification SQLite3
    $checks[] = [
        'test' => 'Extension SQLite3',
        'result' => class_exists('SQLite3'),
        'details' => class_exists('SQLite3') ? SQLite3::version()['versionString'] : 'Non disponible'
    ];
    
    // V√©rification PDO SQLite
    $checks[] = [
        'test' => 'PDO SQLite',
        'result' => extension_loaded('pdo_sqlite'),
        'details' => extension_loaded('pdo_sqlite') ? 'Disponible' : 'Non disponible'
    ];
    
    return $checks;
}

// Cr√©ation des fichiers n√©cessaires
function createFiles($installPath) {
    $files = [];
    
    // Contenu .htaccess principal
    $htaccessContent = 'RewriteEngine On

# Protection des fichiers sensibles
<Files ~ "\.(json|log|sqlite3?)$">
    Deny from all
</Files>

# Protection du dossier data (base de donn√©es)
<IfModule mod_rewrite.c>
    RewriteRule ^data/ - [F,L]
</IfModule>

# Redirection de toutes les requ√™tes vers le router SGC-AgentOne
RewriteCond %{REQUEST_FILENAME} !-f
RewriteCond %{REQUEST_FILENAME} !-d
RewriteRule ^(.*)$ core/router.php [QSA,L]

# Cache d√©sactiv√© pour d√©veloppement
<IfModule mod_headers.c>
    Header set Cache-Control "no-cache, no-store, must-revalidate"
    Header set Pragma "no-cache"
    Header set Expires "0"
</IfModule>

# Optimisations PHP pour h√©bergement mutualis√©
<IfModule mod_php.c>
    php_value max_execution_time 60
    php_value memory_limit 128M
    php_value post_max_size 16M
    php_value upload_max_filesize 16M
</IfModule>';

    // Contenu index.php principal avec d√©tection intelligente
    $indexContent = '<?php
/**
 * SGC-AgentOne Plug & Play - Point d\'entr√©e intelligent
 * Auto-d√©tecte l\'environnement et calcule les chemins dynamiquement
 */

// Configuration d\'erreurs pour production
error_reporting(E_ALL);
ini_set(\'display_errors\', 0);
ini_set(\'log_errors\', 1);

// D√©tection intelligente des chemins
$currentPath = dirname($_SERVER[\'SCRIPT_NAME\']);
$interfaceUrl = $currentPath . \'/extensions/webview/chat.html\';

// V√©rification que l\'interface existe
$interfaceFile = __DIR__ . \'/extensions/webview/chat.html\';
if (!file_exists($interfaceFile)) {
    // Interface non trouv√©e - affichage d\'erreur avec diagnostic
    ?>
    <!DOCTYPE html>
    <html lang="fr">
    <head>
        <meta charset="UTF-8">
        <title>SGC-AgentOne - Configuration</title>
        <style>body{font-family:Arial,sans-serif;margin:50px;background:#f5f5f5}.error{background:#fff3cd;border-left:4px solid #ffc107;padding:15px}</style>
    </head>
    <body>
        <h1>üîå SGC-AgentOne Plug & Play</h1>
        <div class="error">
            <h3>‚ùå Configuration incompl√®te</h3>
            <p>L\'interface SGC-AgentOne n\'est pas trouv√©e √† l\'emplacement attendu.</p>
            <p><strong>Fichier recherch√© :</strong> <?php echo $interfaceFile; ?></p>
            <p><strong>R√©pertoire actuel :</strong> <?php echo __DIR__; ?></p>
            <hr>
            <p><strong>Solution :</strong> Assurez-vous que tous les fichiers SGC-AgentOne sont pr√©sents dans ce dossier.</p>
        </div>
    </body>
    </html>
    <?php
    exit();
}

// Headers pour redirection propre
header(\'HTTP/1.1 302 Found\');
header(\'Location: \' . $interfaceUrl);
header(\'Cache-Control: no-cache, no-store, must-revalidate\');

// Message de fallback si la redirection √©choue
?>
<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SGC-AgentOne</title>
    <meta http-equiv="refresh" content="2; url=<?php echo $interfaceUrl; ?>">
    <style>
        body{font-family:Arial,sans-serif;text-align:center;margin-top:100px;background:#f5f5f5}
        .container{background:white;padding:50px;border-radius:10px;display:inline-block;box-shadow:0 4px 6px rgba(0,0,0,0.1)}
        .loader{border:4px solid #f3f3f3;border-top:4px solid #007bff;border-radius:50%;width:40px;height:40px;animation:spin 1s linear infinite;margin:20px auto}
        @keyframes spin{0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}
        a{color:#007bff;text-decoration:none}a:hover{text-decoration:underline}
    </style>
</head>
<body>
    <div class="container">
        <h1>üöÄ SGC-AgentOne</h1>
        <div class="loader"></div>
        <p>Redirection vers l\'interface...</p>
        <p><a href="<?php echo $interfaceUrl; ?>">Cliquez ici si la redirection ne fonctionne pas</a></p>
        <div style="margin-top:20px;font-size:12px;color:#666">
            <strong>Interface :</strong> <code><?php echo $interfaceUrl; ?></code>
        </div>
    </div>
</body>
</html>';

    // Contenu .htaccess pour data/
    $dataHtaccessContent = '# Protection totale du dossier data (base de donn√©es SQLite)
Deny from all

# Protection sp√©cifique des fichiers de base de donn√©es
<Files ~ "\.sqlite3?$">
    Order allow,deny
    Deny from all
</Files>

# Protection des fichiers de log
<Files ~ "\.log$">
    Order allow,deny
    Deny from all
</Files>';

    // Cr√©ation des fichiers
    $files[] = [
        'path' => $installPath . '/.htaccess',
        'content' => $htaccessContent,
        'name' => '.htaccess principal'
    ];
    
    $files[] = [
        'path' => $installPath . '/index.php',
        'content' => $indexContent,
        'name' => 'index.php d\'entr√©e'
    ];
    
    // Cr√©ation du dossier data/ si n√©cessaire
    $dataDir = $installPath . '/data';
    if (!is_dir($dataDir)) {
        mkdir($dataDir, 0755, true);
    }
    
    $files[] = [
        'path' => $dataDir . '/.htaccess',
        'content' => $dataHtaccessContent,
        'name' => '.htaccess protection data/'
    ];
    
    return $files;
}

// Affichage des r√©sultats
echo "<h3>üîç V√©rification de l'environnement</h3>";
$checks = checkEnvironment();
$allOk = true;

foreach ($checks as $check) {
    $status = $check['result'] ? '‚úÖ' : '‚ùå';
    $color = $check['result'] ? 'green' : 'red';
    echo "<div style='color: {$color};'>{$status} {$check['test']}: {$check['details']}</div>";
    if (!$check['result']) $allOk = false;
}

if (!$allOk) {
    echo "<br><div style='color: red; font-weight: bold;'>‚ùå Certaines v√©rifications ont √©chou√©. Contactez votre h√©bergeur.</div>";
    exit();
}

echo "<br><h3>üìÅ Cr√©ation des fichiers d'installation</h3>";

// Utiliser le chemin d'installation d√©tect√©
$files = createFiles($installPath);

foreach ($files as $file) {
    $result = file_put_contents($file['path'], $file['content']);
    if ($result !== false) {
        echo "‚úÖ {$file['name']} cr√©√©: {$file['path']}<br>";
    } else {
        echo "‚ùå Erreur lors de la cr√©ation de {$file['name']}<br>";
    }
}

echo "<br><h3>üéØ Installation termin√©e !</h3>";

// Instructions finales avec URLs dynamiques
$protocol = (!empty($_SERVER['HTTPS']) && $_SERVER['HTTPS'] !== 'off') ? 'https' : 'http';
$baseUrl = $protocol . '://' . $env['server_name'];
$sgcPath = $env['base_url'];

// Calcul des URLs d'acc√®s selon l'environnement
$mainUrl = $baseUrl . $sgcPath . '/';
$chatUrl = $baseUrl . $sgcPath . '/extensions/webview/chat.html';
$apiUrl = $baseUrl . $sgcPath . '/api/chat';

echo "<div style='background: #f0f8ff; padding: 15px; border-left: 4px solid #007cba;'>";
echo "<strong>üöÄ Votre SGC-AgentOne est pr√™t !</strong><br><br>";

echo "<div style='background: #e8f5e8; padding: 10px; border-radius: 5px; margin: 10px 0;'>";
echo "<strong>üåç Environnement d√©tect√© :</strong> " . ($env['is_localhost'] ? 'üñ•Ô∏è Local' : 'üåê Web') . "<br>";
echo "<strong>üìç Serveur :</strong> " . $env['server_name'] . "<br>";
echo "<strong>üìÇ Installation :</strong> " . $installPath . "<br>";
echo "</div>";

echo "<strong>üîó Acc√®s principal :</strong><br>";
echo "üåê <a href='{$mainUrl}' target='_blank'>{$mainUrl}</a><br><br>";
echo "<strong>üîó Acc√®s direct :</strong><br>";
echo "üí¨ <a href='{$chatUrl}' target='_blank'>Interface Chat</a><br>";
echo "üîß <a href='{$apiUrl}' target='_blank'>API REST</a><br><br>";
echo "<strong>Fonctionnalit√©s disponibles :</strong><br>";
echo "‚Ä¢ Chat intelligent multilingue (fran√ßais/anglais)<br>";
echo "‚Ä¢ Gestionnaire de fichiers complet<br>";
echo "‚Ä¢ √âditeur Monaco int√©gr√©<br>";
echo "‚Ä¢ Base de donn√©es SQLite<br>";
echo "‚Ä¢ 7 vues professionnelles<br>";
echo "</div>";

echo "<br><div style='color: #666; font-size: 12px;'>";
echo "‚ö†Ô∏è Ce script peut √™tre supprim√© apr√®s installation.<br>";
echo "üìù Logs d'erreurs disponibles dans les logs de votre h√©bergeur.";
echo "</div>";
?>