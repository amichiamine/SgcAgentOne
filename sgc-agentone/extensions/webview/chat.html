<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SGC-AgentOne Chat</title>
    <!-- Fonts -->
    <link rel="stylesheet" href="extensions/webview/theme/fonts.css">
    <!-- Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <!-- Monaco Editor -->
    <link rel="stylesheet" data-name="vs/editor/editor.main" href="https://cdn.jsdelivr.net/npm/monaco-editor@0.41.0/min/vs/editor/editor.main.css">
    <!-- Theme -->
    <link rel="stylesheet" href="extensions/webview/theme/colors.css">
    <link rel="stylesheet" href="extensions/webview/theme/syntax.css">
    <style>
        body {
            margin: 0;
            padding: 0;
            background: var(--background);
            color: var(--foreground);
            height: 100vh;
            display: flex;
            flex-direction: column;
            font-family: 'Inter', sans-serif;
        }

        .header {
            display: flex;
            align-items: center;
            height: 48px;
            padding: 0 1rem;
            background: var(--card);
            border-bottom: 1px solid var(--border);
            justify-content: space-between;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-weight: 600;
            color: var(--primary);
        }

        .nav-buttons {
            display: flex;
            gap: 0.5rem;
        }

        .nav-button {
            /* Utilisation des classes clay */
        }

        /* === STYLES POUR L'ÉDITEUR === */
        .editor-tab {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            background: var(--background);
            border: 1px solid var(--border);
            border-radius: 6px 6px 0 0;
            cursor: pointer;
            transition: background-color 0.2s;
            font-size: 0.9rem;
        }

        .editor-tab:hover {
            background: var(--card);
        }

        .editor-tab.active {
            background: var(--card);
            border-bottom-color: var(--card);
        }

        .editor-tab .tab-close {
            background: none;
            border: none;
            color: var(--muted-foreground);
            cursor: pointer;
            padding: 2px 4px;
            border-radius: 2px;
            margin-left: 0.5rem;
            font-size: 1rem;
            line-height: 1;
        }

        .editor-tab .tab-close:hover {
            background: var(--destructive);
            color: white;
        }

        #fileTree .file-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.25rem 0.5rem;
            cursor: pointer;
            border-radius: 4px;
            font-size: 0.9rem;
        }

        #fileTree .file-item:hover {
            background: var(--secondary);
        }

        #fileTree .file-item.selected {
            background: var(--primary);
            color: white;
        }

        #fileTree .folder-item {
            font-weight: 500;
            color: var(--primary);
        }

        .monaco-editor {
            /* Monaco va s'intégrer ici */
        }

        .chat-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        .messages {
            flex: 1;
            padding: 1rem;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        
        .message {
            padding: 1rem;
            border-radius: 12px;
            max-width: 80%;
            word-wrap: break-word;
        }

        .message.user {
            background: linear-gradient(145deg, var(--primary), var(--primary));
            color: var(--background);
            align-self: flex-end;
            margin-left: auto;
            box-shadow: 4px 4px 8px var(--background);
        }
        
        .message.ai {
            /* Utilisation de la classe clay-panel pour l'AI */
            color: var(--foreground);
            align-self: flex-start;
        }
        
        .input-container {
            padding: 1rem;
            background: var(--card);
            border-top: 1px solid var(--border);
            display: flex;
            gap: 0.5rem;
        }
        
        .message-input {
            flex: 1;
            padding: 0.75rem;
            background: var(--secondary);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--foreground);
            font-size: 1rem;
            font-family: 'Inter', sans-serif;
        }
        
        .message-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 2px hsla(188, 95%, 42%, 0.2);
        }
        
        .send-button {
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            color: var(--background);
            font-weight: 500;
            font-family: 'Inter', sans-serif;
            /* Utilisation de la classe clay-button */
        }
        
        .send-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }
        
        /* Syntax highlighting demo styles */
        .syntax-demo {
            margin-top: 1rem;
            padding: 1rem;
            border-radius: 8px;
            font-family: 'Fira Code', monospace;
            font-size: 0.9rem;
            line-height: 1.4;
        }
        
        .syntax-demo code {
            display: block;
            white-space: pre-wrap;
        }
    </style>
</head>
<body>
    <div class="header clay-panel">
        <div class="logo">
            <i class="fas fa-robot"></i>
            SGC-AgentOne
        </div>
        <div class="nav-buttons">
            <button class="nav-button clay-button active" data-tab="chat">
                <i class="fas fa-comments"></i>
            </button>
            <button class="nav-button clay-button" data-tab="files">
                <i class="fas fa-folder"></i>
            </button>
            <button class="nav-button clay-button" data-tab="database">
                <i class="fas fa-database"></i>
            </button>
            <button class="nav-button clay-button" data-tab="prompts">
                <i class="fas fa-magic"></i>
            </button>
            <button class="nav-button clay-button" data-tab="settings">
                <i class="fas fa-cog"></i>
            </button>
            <button class="nav-button clay-button" data-tab="server">
                <i class="fas fa-server"></i>
            </button>
            <button class="nav-button clay-button" data-tab="editor">
                <i class="fas fa-code"></i>
            </button>
            <button class="nav-button clay-button" data-tab="browser">
                <i class="fas fa-globe"></i>
            </button>
        </div>
    </div>
    
    <div class="chat-container clay-panel">
        <div class="messages" id="messages">
            <div class="message ai clay-panel">
                <div>👋 Bonjour ! Je suis SGC-AgentOne, votre assistant IA.</div>
                <div style="margin-top: 0.5rem;">Vous pouvez me demander de :</div>
                <ul style="margin: 0.5rem 0 0 1.5rem;">
                    <li>Créer des fichiers (HTML, CSS, JS, PHP, JSON...)</li>
                    <li>Modifier des fichiers existants</li>
                    <li>Lire le contenu de fichiers</li>
                    <li>Créer et gérer une base SQLite</li>
                    <li>Exécuter des requêtes SQL</li>
                </ul>
                <div style="margin-top: 0.5rem;">Essayez : <em>"Crée un fichier index.html avec une page d'accueil"</em></div>
                
                <!-- Démonstration de la coloration syntaxique -->
                <div class="syntax-demo clay-panel" style="margin-top: 1rem;">
                    <div style="margin-bottom: 0.5rem; font-weight: 600;">🎨 Démonstration de la coloration syntaxique :</div>
                    <code>
<span class="syntax-php">&lt;?php</span>
<span class="syntax-keyword">function</span> <span class="syntax-php">greeting</span>(<span class="syntax-keyword">string</span> <span class="syntax-php">$name</span>) {
    <span class="syntax-keyword">return</span> <span class="syntax-string">"Hello " . $name . "!"</span>; <span class="syntax-comment">// Message de bienvenue</span>
}

<span class="syntax-php">$count</span> = <span class="syntax-number">42</span>;
<span class="syntax-keyword">echo</span> <span class="syntax-string">"<span class="syntax-html">&lt;h1&gt;</span>SGC-AgentOne<span class="syntax-html">&lt;/h1&gt;</span>"</span>;
<span class="syntax-php">?&gt;</span>
                    </code>
                </div>
            </div>
        </div>
        
        <div class="input-container clay-panel">
            <input 
                type="text" 
                class="message-input" 
                id="messageInput" 
                placeholder="Tapez votre message ici..."
                autocomplete="off"
            >
            <button class="send-button clay-button" id="sendButton">Envoyer</button>
        </div>
    </div>

    <script>
        // Variables globales
        let messagesContainer, messageInput, sendButton;
        
        function addMessage(content, isUser = false) {
            const messagesContainer = document.getElementById('messages');
            if (!messagesContainer) return;
            
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${isUser ? 'user' : 'ai clay-panel'}`;
            messageDiv.innerHTML = content;
            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }
        
        // Variables globales SGC-AgentOne
        let authToken = null;
        let currentWorkingDirectory = '.'; // Dossier de travail global pour toutes les vues
        
        // Get authentication token from server (secure approach)
        async function getAuthToken() {
            if (!authToken) {
                try {
                    const response = await fetch('/api/auth/token', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            client_type: 'webview'
                        })
                    });
                    if (response.ok) {
                        const data = await response.json();
                        authToken = data.token;
                        console.log('🔐 Token d\'authentification obtenu');
                    }
                } catch (error) {
                    console.log('🔓 Authentification non requise, procédure sans token');
                }
            }
            return authToken;
        }
        
        async function sendMessage() {
            const messageInput = document.getElementById('messageInput');
            if (!messageInput) {
                console.error('Element messageInput non trouvé');
                return;
            }
            
            const message = messageInput.value.trim();
            if (!message) return;
            
            // Afficher le message utilisateur
            addMessage(message, true);
            messageInput.value = '';
            
            const sendButton = document.getElementById('sendButton');
            if (sendButton) {
                sendButton.disabled = true;
                sendButton.textContent = 'Envoi...';
            }
            
            try {
                const token = await getAuthToken();
                const headers = {
                    'Content-Type': 'application/json'
                };
                
                // Ajout du token d'authentification sécurisé si disponible
                if (token) {
                    headers['X-API-Key'] = token;
                }
                
                const response = await fetch('/api/chat', {
                    method: 'POST',
                    headers: headers,
                    body: JSON.stringify({
                        message: message,
                        projectPath: currentWorkingDirectory,
                        blind: false
                    })
                });
                
                const data = await response.json();
                
                if (data.error) {
                    addMessage(`❌ Erreur: ${data.error}`);
                } else {
                    addMessage(data.response || '✅ Action effectuée');
                    
                    // Afficher les actions si présentes
                    if (data.actions && data.actions.length > 0) {
                        const actionsText = data.actions.map(action => 
                            `• ${action.action}: ${action.result}`
                        ).join('<br>');
                        addMessage(`<strong>Actions:</strong><br>${actionsText}`);
                    }
                }
                
            } catch (error) {
                addMessage(`❌ Erreur de connexion: ${error.message}`);
            }
            
            if (sendButton) {
                sendButton.disabled = false;
                sendButton.textContent = 'Envoyer';
            }
            messageInput.focus();
        }
        
        // Initialisation après chargement du DOM
        document.addEventListener('DOMContentLoaded', function() {
            setupInitialListeners();
            initializeInterface();
        });
        
        // Gestionnaire de messages pour la communication iframe
        window.addEventListener('message', function(event) {
            // Vérifier l'origine pour la sécurité
            if (event.origin !== window.location.origin) return;
            
            if (event.data.type === 'navigate' && event.data.view) {
                console.log('Navigation demandée depuis iframe:', event.data.view);
                
                // Supprimer la classe active de tous les boutons
                document.querySelectorAll('.nav-button').forEach(b => 
                    b.classList.remove('active'));
                
                // Ajouter la classe active au bouton correspondant
                const targetButton = document.querySelector(`[data-tab="${event.data.view}"]`);
                if (targetButton) {
                    targetButton.classList.add('active');
                }
                
                // Gérer le changement de vue
                handleTabSwitch(event.data.view);
            }
        });

        function setupInitialListeners() {
            // Event listeners pour les boutons de navigation
            document.querySelectorAll('.nav-button').forEach(button => {
                button.addEventListener('click', function() {
                    console.log('Bouton cliqué:', this.dataset.tab);
                    
                    // Supprimer la classe active de tous les boutons
                    document.querySelectorAll('.nav-button').forEach(b => 
                        b.classList.remove('active'));
                    
                    // Ajouter la classe active au bouton cliqué
                    this.classList.add('active');
                    
                    // Gérer l'affichage selon l'onglet
                    const tab = this.dataset.tab;
                    handleTabSwitch(tab);
                });
            });
            
            // Setup initial chat listeners
            setupChatListeners();
        }

        function handleTabSwitch(tab) {
            const chatContainer = document.querySelector('.chat-container');
            
            switch(tab) {
                case 'chat':
                    chatContainer.innerHTML = `
                        <div class="messages" id="messages">
                            <div class="message ai clay-panel">
                                <div>👋 Bonjour ! Je suis SGC-AgentOne, votre assistant IA.</div>
                                <div style="margin-top: 0.5rem;">Vous pouvez me demander de :</div>
                                <ul style="margin: 0.5rem 0 0 1.5rem;">
                                    <li>Créer des fichiers (HTML, CSS, JS, PHP, JSON...)</li>
                                    <li>Modifier des fichiers existants</li>
                                    <li>Lire le contenu de fichiers</li>
                                    <li>Créer et gérer une base SQLite</li>
                                    <li>Exécuter des requêtes SQL</li>
                                </ul>
                                <div style="margin-top: 0.5rem;">Essayez : <em>"Crée un fichier index.html avec une page d'accueil"</em></div>
                                
                                <!-- Démonstration de la coloration syntaxique -->
                                <div class="syntax-demo clay-panel" style="margin-top: 1rem;">
                                    <div style="margin-bottom: 0.5rem; font-weight: 600;">🎨 Démonstration de la coloration syntaxique :</div>
                                    <code>
<span class="syntax-php">&lt;?php</span>
<span class="syntax-keyword">function</span> <span class="syntax-php">greeting</span>(<span class="syntax-keyword">string</span> <span class="syntax-php">$name</span>) {
    <span class="syntax-keyword">return</span> <span class="syntax-string">"Hello " . $name . "!"</span>; <span class="syntax-comment">// Message de bienvenue</span>
}

<span class="syntax-php">$count</span> = <span class="syntax-number">42</span>;
<span class="syntax-keyword">echo</span> <span class="syntax-string">"<span class="syntax-html">&lt;h1&gt;</span>SGC-AgentOne<span class="syntax-html">&lt;/h1&gt;</span>"</span>;
<span class="syntax-php">?&gt;</span>
                                    </code>
                                </div>
                            </div>
                        </div>
                        
                        <div class="input-container clay-panel">
                            <input 
                                type="text" 
                                class="message-input" 
                                id="messageInput" 
                                placeholder="Tapez votre message ici..."
                                autocomplete="off"
                            >
                            <button class="send-button clay-button" id="sendButton">Envoyer</button>
                        </div>
                    `;
                    setupChatListeners();
                    break;
                    
                case 'files':
                    chatContainer.innerHTML = `
                        <div class="tab-content clay-panel" style="flex: 1; padding: 1.5rem; margin: 1rem; overflow-y: auto;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                                <h2><i class="fas fa-folder"></i> Gestionnaire de fichiers</h2>
                                <div style="display: flex; gap: 0.5rem;">
                                    <button class="clay-button" id="createFileBtn">
                                        <i class="fas fa-plus"></i> Nouveau fichier
                                    </button>
                                    <button class="clay-button" id="refreshFilesBtn">
                                        <i class="fas fa-sync-alt"></i> Actualiser
                                    </button>
                                </div>
                            </div>

                            <!-- Bouton Changer de dossier -->
                            <div class="clay-panel" style="padding: 1rem; margin-bottom: 1rem;">
                                <h4><i class="fas fa-folder-open"></i> Navigation</h4>
                                <div style="display: flex; gap: 0.5rem; align-items: center; margin-top: 1rem;">
                                    <label style="color: var(--foreground); font-weight: 500;">Dossier :</label>
                                    <input type="text" id="folderPathInput" class="message-input" placeholder="Chemin du dossier (ex: ., ../autre-projet, /chemin/absolu)" value="." style="flex: 1; padding: 0.5rem;">
                                    <button class="clay-button" id="changeFolderBtn" style="background: var(--primary); color: var(--background);">
                                        <i class="fas fa-folder-open"></i> Changer
                                    </button>
                                </div>
                                <div style="margin-top: 0.5rem; display: flex; gap: 0.5rem;">
                                    <button class="clay-button" id="parentFolderBtn" title="Dossier parent">
                                        <i class="fas fa-arrow-up"></i> Parent
                                    </button>
                                    <button class="clay-button" id="homeFolderBtn" title="Racine du projet">
                                        <i class="fas fa-home"></i> Racine
                                    </button>
                                    <span style="color: var(--muted-foreground); font-size: 0.9rem; align-self: center; margin-left: auto;">
                                        Actuel: <span id="currentFolderDisplay">.</span>
                                    </span>
                                </div>
                            </div>
                            
                            <div class="clay-panel" style="padding: 1rem; margin-bottom: 1rem;">
                                <h4>📂 Répertoire projet</h4>
                                <div id="fileTree" style="margin-top: 1rem; font-family: 'JetBrains Mono', monospace; font-size: 0.9rem;">
                                    <div class="file-item" style="padding: 0.25rem; cursor: pointer; border-radius: 4px; margin: 2px 0;">
                                        <i class="fas fa-folder text-primary"></i> sgc-agentone/
                                    </div>
                                    <div class="file-item" style="padding: 0.25rem 0 0.25rem 1.5rem; cursor: pointer; border-radius: 4px; margin: 2px 0;">
                                        <i class="fas fa-folder"></i> core/
                                    </div>
                                    <div class="file-item" style="padding: 0.25rem 0 0.25rem 1.5rem; cursor: pointer; border-radius: 4px; margin: 2px 0;">
                                        <i class="fas fa-folder"></i> extensions/
                                    </div>
                                    <div class="file-item" style="padding: 0.25rem; cursor: pointer; border-radius: 4px; margin: 2px 0;">
                                        <i class="fas fa-file-alt"></i> replit.md
                                    </div>
                                </div>
                            </div>
                            
                            <div class="clay-panel" style="padding: 1rem;">
                                <h4>🛠️ Actions rapides</h4>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-top: 1rem;">
                                    <button class="clay-button" id="createHtmlBtn">
                                        <i class="fas fa-code"></i> Créer HTML
                                    </button>
                                    <button class="clay-button" id="createCssBtn">
                                        <i class="fas fa-paint-brush"></i> Créer CSS
                                    </button>
                                    <button class="clay-button" id="createJsBtn">
                                        <i class="fas fa-cogs"></i> Créer JS
                                    </button>
                                    <button class="clay-button" id="createPhpBtn">
                                        <i class="fas fa-server"></i> Créer PHP
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                    setupFilesListeners();
                    break;
                    
                case 'database':
                    chatContainer.innerHTML = `
                        <div class="tab-content clay-panel" style="flex: 1; padding: 1.5rem; margin: 1rem; overflow-y: auto;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                                <h2><i class="fas fa-database"></i> Base de données SQLite</h2>
                                <div style="display: flex; gap: 0.5rem;">
                                    <button class="clay-button" id="connectDbBtn">
                                        <i class="fas fa-plug"></i> Connecter
                                    </button>
                                    <button class="clay-button" id="createTableBtn">
                                        <i class="fas fa-table"></i> Nouvelle table
                                    </button>
                                </div>
                            </div>
                            
                            <div class="clay-panel" style="padding: 1rem; margin-bottom: 1rem;">
                                <h4>📊 État de la base</h4>
                                <div style="margin-top: 1rem; display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem; text-align: center;">
                                    <div style="padding: 1rem; background: var(--secondary); border-radius: 8px;">
                                        <div style="font-size: 1.5rem; color: var(--primary); font-weight: bold;">1</div>
                                        <div style="font-size: 0.9rem; color: var(--muted-foreground);">Base connectée</div>
                                    </div>
                                    <div style="padding: 1rem; background: var(--secondary); border-radius: 8px;">
                                        <div style="font-size: 1.5rem; color: var(--primary); font-weight: bold;">0</div>
                                        <div style="font-size: 0.9rem; color: var(--muted-foreground);">Tables</div>
                                    </div>
                                    <div style="padding: 1rem; background: var(--secondary); border-radius: 8px;">
                                        <div style="font-size: 1.5rem; color: var(--primary); font-weight: bold;">0</div>
                                        <div style="font-size: 0.9rem; color: var(--muted-foreground);">Enregistrements</div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="clay-panel" style="padding: 1rem; margin-bottom: 1rem;">
                                <h4>💾 Éditeur SQL</h4>
                                <textarea id="sqlEditor" class="message-input" style="width: 100%; height: 120px; resize: vertical; font-family: 'JetBrains Mono', monospace; margin-top: 1rem;" placeholder="SELECT * FROM sqlite_master WHERE type='table';"></textarea>
                                <div style="display: flex; justify-content: space-between; margin-top: 1rem;">
                                    <div style="display: flex; gap: 0.5rem;">
                                        <button class="clay-button" id="executeQueryBtn">
                                            <i class="fas fa-play"></i> Exécuter
                                        </button>
                                        <button class="clay-button" id="clearQueryBtn">
                                            <i class="fas fa-times"></i> Effacer
                                        </button>
                                    </div>
                                    <select class="message-input" style="width: auto; padding: 0.5rem;">
                                        <option>Requêtes prédéfinies</option>
                                        <option value="tables">Lister les tables</option>
                                        <option value="users">Créer table users</option>
                                        <option value="insert">Insérer données test</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div class="clay-panel" style="padding: 1rem;">
                                <h4>📋 Résultats</h4>
                                <div id="sqlResults" style="margin-top: 1rem; padding: 1rem; background: var(--secondary); border-radius: 8px; font-family: 'JetBrains Mono', monospace; min-height: 60px; color: var(--muted-foreground);">
                                    Exécutez une requête pour voir les résultats...
                                </div>
                            </div>
                        </div>
                    `;
                    setupDatabaseListeners();
                    break;
                    
                case 'prompts':
                    chatContainer.innerHTML = `
                        <div class="tab-content clay-panel" style="flex: 1; padding: 1.5rem; margin: 1rem; overflow-y: auto;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                                <h2><i class="fas fa-magic"></i> Constructeur de Prompts</h2>
                                <div style="display: flex; gap: 0.5rem;">
                                    <button class="clay-button" id="refreshPatternsBtn">
                                        <i class="fas fa-sync-alt"></i> Actualiser
                                    </button>
                                    <button class="clay-button" id="exportPatternsBtn">
                                        <i class="fas fa-download"></i> Exporter
                                    </button>
                                </div>
                            </div>

                            <!-- Zone de recherche -->
                            <div class="clay-panel" style="padding: 1rem; margin-bottom: 1rem;">
                                <div style="display: flex; align-items: center; gap: 0.5rem;">
                                    <i class="fas fa-search" style="color: var(--muted-foreground);"></i>
                                    <input type="text" id="searchPatterns" placeholder="Rechercher dans les patterns..." 
                                           style="flex: 1; padding: 0.5rem; border: 1px solid var(--border); border-radius: 6px; background: var(--background); color: var(--foreground);">
                                </div>
                            </div>

                            <!-- Liste des patterns existants -->
                            <div class="clay-panel" style="padding: 1rem; margin-bottom: 1rem;">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                                    <h4><i class="fas fa-list"></i> Patterns existants (<span id="patternsCount">0</span>)</h4>
                                    <div style="display: flex; gap: 0.5rem; align-items: center;">
                                        <span style="font-size: 0.8rem; color: var(--muted-foreground);">Filtrer par action:</span>
                                        <select id="filterAction" style="padding: 0.25rem; border: 1px solid var(--border); border-radius: 4px; background: var(--background); color: var(--foreground);">
                                            <option value="">Toutes</option>
                                            <option value="create file">create file</option>
                                            <option value="update file">update file</option>
                                            <option value="read file">read file</option>
                                            <option value="create database">create database</option>
                                            <option value="execute query">execute query</option>
                                        </select>
                                    </div>
                                </div>
                                <div id="patternsList" style="max-height: 300px; overflow-y: auto;">
                                    <div style="text-align: center; color: var(--muted-foreground); padding: 2rem;">
                                        <i class="fas fa-spinner fa-spin"></i> Chargement des patterns...
                                    </div>
                                </div>
                            </div>

                            <!-- Formulaire nouveau pattern -->
                            <div class="clay-panel" style="padding: 1rem; margin-bottom: 1rem;">
                                <h4><i class="fas fa-plus"></i> Nouveau Pattern</h4>
                                <div style="display: grid; gap: 1rem; margin-top: 1rem;">
                                    <div>
                                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Pattern de commande:</label>
                                        <input type="text" id="newPattern" placeholder="Ex: génère une API REST pour *" 
                                               style="width: 100%; padding: 0.75rem; border: 1px solid var(--border); border-radius: 6px; background: var(--background); color: var(--foreground);">
                                        <div style="font-size: 0.8rem; color: var(--muted-foreground); margin-top: 0.25rem;">
                                            Utilisez * pour capturer des paramètres. Ex: "crée un fichier *" capturera le nom du fichier.
                                        </div>
                                    </div>
                                    <div>
                                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Action correspondante:</label>
                                        <select id="newAction" style="width: 100%; padding: 0.75rem; border: 1px solid var(--border); border-radius: 6px; background: var(--background); color: var(--foreground);">
                                            <option value="">Sélectionnez une action...</option>
                                            <option value="create file">create file - Créer un fichier</option>
                                            <option value="update file">update file - Modifier un fichier</option>
                                            <option value="read file">read file - Lire un fichier</option>
                                            <option value="create database">create database - Créer base de données</option>
                                            <option value="execute query">execute query - Exécuter requête SQL</option>
                                        </select>
                                    </div>
                                    <div style="display: flex; gap: 0.5rem;">
                                        <button class="clay-button" id="addPatternBtn" style="flex: 1;">
                                            <i class="fas fa-plus"></i> Ajouter Pattern
                                        </button>
                                        <button class="clay-button" id="testPatternBtn">
                                            <i class="fas fa-vial"></i> Tester
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <!-- Testeur en temps réel -->
                            <div class="clay-panel" style="padding: 1rem; margin-bottom: 1rem;">
                                <h4><i class="fas fa-flask"></i> Testeur en temps réel</h4>
                                <div style="margin-top: 1rem;">
                                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Commande à tester:</label>
                                    <input type="text" id="testCommand" placeholder="Ex: génère une API pour utilisateurs" 
                                           style="width: 100%; padding: 0.75rem; border: 1px solid var(--border); border-radius: 6px; background: var(--background); color: var(--foreground);">
                                </div>
                                <div id="testResult" style="margin-top: 1rem; padding: 1rem; background: var(--secondary); border-radius: 6px; min-height: 60px;">
                                    <div style="color: var(--muted-foreground); text-align: center;">
                                        Tapez une commande ci-dessus pour voir l'interprétation en temps réel...
                                    </div>
                                </div>
                            </div>

                            <!-- Actions rapides -->
                            <div class="clay-panel" style="padding: 1rem;">
                                <h4><i class="fas fa-bolt"></i> Templates rapides</h4>
                                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-top: 1rem;">
                                    <button class="clay-button" id="templateCreateFile">
                                        <i class="fas fa-file"></i> Templates Création
                                    </button>
                                    <button class="clay-button" id="templateModifyFile">
                                        <i class="fas fa-edit"></i> Templates Modification
                                    </button>
                                    <button class="clay-button" id="templateDatabase">
                                        <i class="fas fa-database"></i> Templates Database
                                    </button>
                                    <button class="clay-button" id="resetPatternsBtn">
                                        <i class="fas fa-undo"></i> Réinitialiser
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                    setupPromptsListeners();
                    break;
                    
                case 'settings':
                    chatContainer.innerHTML = `
                        <div class="tab-content clay-panel" style="flex: 1; padding: 1.5rem; margin: 1rem; overflow-y: auto;">
                            <h2><i class="fas fa-cog"></i> Paramètres SGC-AgentOne</h2>
                            
                            <div class="clay-panel" style="padding: 1rem; margin: 1rem 0;">
                                <h4>🎨 Interface et thème</h4>
                                <div style="margin-top: 1rem;">
                                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Thème actuel :</label>
                                    <div style="display: flex; gap: 1rem; margin-top: 0.5rem;">
                                        <button class="clay-button active" id="themeCommanderBtn">
                                            <i class="fas fa-palette"></i> SGC-Commander
                                        </button>
                                        <button class="clay-button" id="themeDarkBtn">
                                            <i class="fas fa-moon"></i> Sombre classique
                                        </button>
                                        <button class="clay-button" id="themeLightBtn">
                                            <i class="fas fa-sun"></i> Clair
                                        </button>
                                    </div>
                                </div>
                                <div style="margin-top: 1rem;">
                                    <label style="display: flex; align-items: center; gap: 0.5rem;">
                                        <input type="checkbox" checked style="accent-color: var(--primary);">
                                        <span>Effets Claymorphism activés</span>
                                    </label>
                                </div>
                            </div>
                            
                            <div class="clay-panel" style="padding: 1rem; margin: 1rem 0;">
                                <h4>🔧 Fonctionnalités</h4>
                                <div style="margin-top: 1rem; display: grid; gap: 1rem;">
                                    <label style="display: flex; align-items: center; gap: 0.5rem;">
                                        <input type="checkbox" checked style="accent-color: var(--primary);">
                                        <span>Mode développement activé</span>
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 0.5rem;">
                                        <input type="checkbox" checked style="accent-color: var(--primary);">
                                        <span>Logging détaillé</span>
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 0.5rem;">
                                        <input type="checkbox" style="accent-color: var(--primary);">
                                        <span>Exécution en mode aveugle (dangereux)</span>
                                    </label>
                                </div>
                                <div style="margin-top: 1rem;">
                                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Port serveur :</label>
                                    <input type="number" class="message-input" value="5000" style="width: 100px;" readonly>
                                    <span style="margin-left: 0.5rem; color: var(--muted-foreground);">Lecture seule</span>
                                </div>
                            </div>
                            
                            <div class="clay-panel" style="padding: 1rem; margin: 1rem 0;">
                                <h4>🔐 Sécurité</h4>
                                <div style="margin-top: 1rem;">
                                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Clé API :</label>
                                    <div style="display: flex; gap: 0.5rem; align-items: center;">
                                        <input type="password" class="message-input" value="••••••••••••••••••••" style="flex: 1;" readonly>
                                        <button class="clay-button" id="regenerateApiBtn">
                                            <i class="fas fa-sync-alt"></i> Regénérer
                                        </button>
                                    </div>
                                </div>
                                <div style="margin-top: 1rem;">
                                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Origines autorisées :</label>
                                    <div style="font-family: 'JetBrains Mono', monospace; background: var(--secondary); padding: 1rem; border-radius: 8px; font-size: 0.9rem;">
                                        • http://localhost:5000<br>
                                        • https://*.replit.dev
                                    </div>
                                </div>
                            </div>
                            
                            <div class="clay-panel" style="padding: 1rem; margin: 1rem 0;">
                                <h4>💾 Actions système</h4>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-top: 1rem;">
                                    <button class="clay-button" id="exportConfigBtn">
                                        <i class="fas fa-download"></i> Exporter config
                                    </button>
                                    <button class="clay-button" id="importConfigBtn">
                                        <i class="fas fa-upload"></i> Importer config
                                    </button>
                                    <button class="clay-button" id="clearLogsBtn">
                                        <i class="fas fa-trash"></i> Vider logs
                                    </button>
                                    <button class="clay-button" id="restartServerBtn">
                                        <i class="fas fa-power-off"></i> Redémarrer
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                    setupSettingsListeners();
                    break;
                    
                case 'server':
                    chatContainer.innerHTML = `
                        <div class="tab-content clay-panel" style="flex: 1; padding: 1.5rem; margin: 1rem; overflow-y: auto;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                                <h2><i class="fas fa-server"></i> Gestion Serveur SGC-AgentOne</h2>
                                <div style="display: flex; gap: 0.5rem;">
                                    <button class="clay-button" id="refreshServerBtn">
                                        <i class="fas fa-sync-alt"></i> Actualiser
                                    </button>
                                    <div id="serverStatus" style="padding: 0.5rem 1rem; background: var(--primary); color: white; border-radius: 6px; font-size: 0.8rem;">
                                        <i class="fas fa-circle"></i> EN LIGNE
                                    </div>
                                </div>
                            </div>

                            <!-- État du serveur -->
                            <div class="clay-panel" style="padding: 1rem; margin-bottom: 1rem;">
                                <h4><i class="fas fa-info-circle"></i> État du serveur</h4>
                                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-top: 1rem;">
                                    <div style="padding: 1rem; background: var(--secondary); border-radius: 8px; text-align: center;">
                                        <div style="font-size: 1.2rem; color: var(--primary); font-weight: bold;" id="serverUptime">--:--:--</div>
                                        <div style="font-size: 0.9rem; color: var(--muted-foreground);">Uptime</div>
                                    </div>
                                    <div style="padding: 1rem; background: var(--secondary); border-radius: 8px; text-align: center;">
                                        <div style="font-size: 1.2rem; color: var(--primary); font-weight: bold;" id="serverPort">5000</div>
                                        <div style="font-size: 0.9rem; color: var(--muted-foreground);">Port</div>
                                    </div>
                                    <div style="padding: 1rem; background: var(--secondary); border-radius: 8px; text-align: center;">
                                        <div style="font-size: 1.2rem; color: var(--primary); font-weight: bold;" id="serverPID">--</div>
                                        <div style="font-size: 0.9rem; color: var(--muted-foreground);">Process ID</div>
                                    </div>
                                    <div style="padding: 1rem; background: var(--secondary); border-radius: 8px; text-align: center;">
                                        <div style="font-size: 1.2rem; color: var(--primary); font-weight: bold;" id="memoryUsage">-- MB</div>
                                        <div style="font-size: 0.9rem; color: var(--muted-foreground);">Mémoire PHP</div>
                                    </div>
                                </div>
                            </div>

                            <!-- Dashboard statistiques -->
                            <div class="clay-panel" style="padding: 1rem; margin-bottom: 1rem;">
                                <h4><i class="fas fa-chart-line"></i> Statistiques en temps réel</h4>
                                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem; margin-top: 1rem;">
                                    <div style="text-align: center;">
                                        <div style="font-size: 1.5rem; color: var(--primary); font-weight: bold;" id="requestsPerSec">0</div>
                                        <div style="font-size: 0.8rem; color: var(--muted-foreground);">Req/sec</div>
                                    </div>
                                    <div style="text-align: center;">
                                        <div style="font-size: 1.5rem; color: var(--primary); font-weight: bold;" id="activeConnections">0</div>
                                        <div style="font-size: 0.8rem; color: var(--muted-foreground);">Connexions</div>
                                    </div>
                                    <div style="text-align: center;">
                                        <div style="font-size: 1.5rem; color: var(--primary); font-weight: bold;" id="totalRequests">0</div>
                                        <div style="font-size: 0.8rem; color: var(--muted-foreground);">Total</div>
                                    </div>
                                </div>
                                <div style="margin-top: 1rem;">
                                    <h5>Routes les plus appelées (dernières 24h)</h5>
                                    <div id="topRoutes" style="margin-top: 0.5rem; background: var(--secondary); padding: 1rem; border-radius: 6px; font-family: 'JetBrains Mono', monospace; font-size: 0.9rem;">
                                        <div>/api/chat - 45 appels</div>
                                        <div>/api/prompts - 23 appels</div>
                                        <div>/api/auth/token - 12 appels</div>
                                    </div>
                                </div>
                            </div>

                            <!-- Logs en temps réel -->
                            <div class="clay-panel" style="padding: 1rem; margin-bottom: 1rem;">
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <h4><i class="fas fa-terminal"></i> Logs serveur temps réel</h4>
                                    <div style="display: flex; gap: 0.5rem;">
                                        <select id="logFilter" style="padding: 0.25rem; border: 1px solid var(--border); border-radius: 4px; background: var(--background);">
                                            <option value="all">Tous</option>
                                            <option value="info">Info</option>
                                            <option value="error">Erreurs</option>
                                            <option value="warning">Warnings</option>
                                        </select>
                                        <button class="clay-button" id="clearLogsDisplayBtn">
                                            <i class="fas fa-broom"></i> Effacer
                                        </button>
                                        <button class="clay-button" id="exportLogsBtn">
                                            <i class="fas fa-download"></i> Export
                                        </button>
                                    </div>
                                </div>
                                <div id="liveLogsContainer" style="margin-top: 1rem; height: 250px; background: var(--secondary); border-radius: 6px; padding: 1rem; overflow-y: auto; font-family: 'JetBrains Mono', monospace; font-size: 0.8rem; color: var(--muted-foreground);">
                                    <div style="color: var(--primary);">[$(new Date().toLocaleTimeString())] Serveur SGC-AgentOne démarré</div>
                                    <div>[$(new Date().toLocaleTimeString())] Écoute sur port 5000</div>
                                    <div>[$(new Date().toLocaleTimeString())] Router configuré</div>
                                    <div style="color: var(--primary);">[$(new Date().toLocaleTimeString())] ✅ Prêt à recevoir des requêtes</div>
                                </div>
                                <div style="display: flex; align-items: center; gap: 0.5rem; margin-top: 0.5rem;">
                                    <input type="checkbox" id="autoScroll" checked>
                                    <label for="autoScroll" style="font-size: 0.9rem;">Auto-scroll</label>
                                    <span style="margin-left: 1rem; font-size: 0.8rem; color: var(--muted-foreground);">Dernière mise à jour: <span id="lastLogUpdate">maintenant</span></span>
                                </div>
                            </div>

                            <!-- Contrôles serveur -->
                            <div class="clay-panel" style="padding: 1rem; margin-bottom: 1rem;">
                                <h4><i class="fas fa-sliders-h"></i> Contrôles serveur</h4>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-top: 1rem;">
                                    <button class="clay-button" id="serverRestartBtn">
                                        <i class="fas fa-redo"></i> Redémarrage graceful
                                    </button>
                                    <button class="clay-button" id="serverStopBtn" style="background: #ff6b6b; border-color: #ff6b6b;">
                                        <i class="fas fa-stop"></i> Arrêter serveur
                                    </button>
                                    <button class="clay-button" id="serverHealthBtn">
                                        <i class="fas fa-heartbeat"></i> Test santé
                                    </button>
                                    <button class="clay-button" id="flushCacheBtn">
                                        <i class="fas fa-trash"></i> Vider cache PHP
                                    </button>
                                </div>
                                <div style="margin-top: 1rem;">
                                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Changer port serveur :</label>
                                    <div style="display: flex; gap: 0.5rem; align-items: center;">
                                        <input type="number" id="newPortInput" value="5000" min="3000" max="65535" style="padding: 0.5rem; border: 1px solid var(--border); border-radius: 4px; width: 100px; background: var(--background);">
                                        <button class="clay-button" id="changePortBtn">
                                            <i class="fas fa-exchange-alt"></i> Changer port
                                        </button>
                                        <span style="font-size: 0.8rem; color: var(--muted-foreground);">Redémarre automatiquement</span>
                                    </div>
                                </div>
                            </div>

                            <!-- Configuration avancée -->
                            <div class="clay-panel" style="padding: 1rem;">
                                <h4><i class="fas fa-wrench"></i> Configuration avancée</h4>
                                <div style="display: grid; gap: 1rem; margin-top: 1rem;">
                                    <div>
                                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Limite mémoire PHP :</label>
                                        <select id="memoryLimitSelect" style="padding: 0.5rem; border: 1px solid var(--border); border-radius: 4px; background: var(--background); width: 200px;">
                                            <option value="128M">128 MB</option>
                                            <option value="256M" selected>256 MB</option>
                                            <option value="512M">512 MB</option>
                                            <option value="1G">1 GB</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Timeout requêtes :</label>
                                        <div style="display: flex; gap: 0.5rem; align-items: center;">
                                            <input type="number" id="timeoutInput" value="30" min="5" max="300" style="padding: 0.5rem; border: 1px solid var(--border); border-radius: 4px; width: 80px; background: var(--background);">
                                            <span style="font-size: 0.9rem;">secondes</span>
                                        </div>
                                    </div>
                                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                                        <input type="checkbox" id="debugModeToggle">
                                        <label for="debugModeToggle">Mode debug avancé (plus de logs)</label>
                                    </div>
                                    <div style="display: flex; gap: 0.5rem; margin-top: 1rem;">
                                        <button class="clay-button" id="applyConfigBtn">
                                            <i class="fas fa-save"></i> Appliquer config
                                        </button>
                                        <button class="clay-button" id="resetConfigBtn">
                                            <i class="fas fa-undo"></i> Reset défaut
                                        </button>
                                        <button class="clay-button" id="exportServerConfigBtn">
                                            <i class="fas fa-download"></i> Export config
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                    setupServerListeners();
                    break;
                    
                case 'editor':
                    chatContainer.innerHTML = `
                        <div class="tab-content clay-panel" style="flex: 1; padding: 0; margin: 1rem; overflow: hidden; display: flex; flex-direction: column;">
                            <div style="display: flex; justify-content: space-between; align-items: center; padding: 1rem; background: var(--card); border-bottom: 1px solid var(--border);">
                                <h2><i class="fas fa-code"></i> Éditeur de Code Monaco</h2>
                                <div style="display: flex; gap: 0.5rem;">
                                    <select id="languageSelect" style="padding: 0.5rem; border: 1px solid var(--border); border-radius: 4px; background: var(--background);">
                                        <option value="javascript">JavaScript</option>
                                        <option value="php">PHP</option>
                                        <option value="html">HTML</option>
                                        <option value="css">CSS</option>
                                        <option value="json">JSON</option>
                                        <option value="sql">SQL</option>
                                        <option value="markdown">Markdown</option>
                                        <option value="plaintext">Text</option>
                                    </select>
                                    <button class="clay-button" id="newFileBtn">
                                        <i class="fas fa-plus"></i> Nouveau
                                    </button>
                                    <button class="clay-button" id="openFileBtn">
                                        <i class="fas fa-folder-open"></i> Ouvrir
                                    </button>
                                    <button class="clay-button" id="saveFileBtn" style="background: var(--primary); color: white;">
                                        <i class="fas fa-save"></i> Sauvegarder
                                    </button>
                                </div>
                            </div>

                            <!-- Onglets de fichiers -->
                            <div id="editorTabs" style="display: flex; background: var(--secondary); border-bottom: 1px solid var(--border); min-height: 40px; align-items: center; padding: 0 1rem; gap: 0.5rem;">
                                <div class="editor-tab active" data-file="untitled.js">
                                    <i class="fas fa-file-code"></i>
                                    <span>untitled.js</span>
                                    <button class="tab-close">&times;</button>
                                </div>
                            </div>

                            <!-- Conteneur principal de l'éditeur -->
                            <div style="flex: 1; display: flex; overflow: hidden;">
                                <!-- Explorateur de fichiers latéral -->
                                <div id="fileExplorer" style="width: 250px; background: var(--card); border-right: 1px solid var(--border); overflow-y: auto;">
                                    <div style="padding: 0.5rem; background: var(--secondary); border-bottom: 1px solid var(--border); font-weight: 600;">
                                        <i class="fas fa-folder"></i> Explorateur
                                    </div>
                                    <div id="fileTree" style="padding: 0.5rem;">
                                        <div style="color: var(--muted-foreground); text-align: center; padding: 2rem;">
                                            <i class="fas fa-spinner fa-spin"></i><br>
                                            Chargement des fichiers...
                                        </div>
                                    </div>
                                </div>

                                <!-- Éditeur Monaco -->
                                <div style="flex: 1; display: flex; flex-direction: column;">
                                    <div id="monacoEditor" style="flex: 1; min-height: 400px;"></div>
                                    
                                    <!-- Barre d'état -->
                                    <div style="height: 24px; background: var(--secondary); border-top: 1px solid var(--border); display: flex; align-items: center; padding: 0 1rem; font-size: 0.8rem; justify-content: space-between;">
                                        <div>
                                            <span id="editorStatus">Prêt</span>
                                            <span style="margin-left: 1rem; color: var(--muted-foreground);">
                                                Ligne <span id="lineNumber">1</span>, Col <span id="columnNumber">1</span>
                                            </span>
                                        </div>
                                        <div style="display: flex; align-items: center; gap: 1rem;">
                                            <span style="color: var(--muted-foreground);">
                                                <span id="fileSize">0</span> caractères
                                            </span>
                                            <span style="color: var(--muted-foreground);">
                                                UTF-8
                                            </span>
                                            <span id="currentLanguage">JavaScript</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                    
                    // Chargement Monaco après création de l'interface
                    loadMonacoEditor();
                    break;
                    
                case 'browser':
                    chatContainer.innerHTML = `
                        <div class="tab-content clay-panel" style="flex: 1; margin: 1rem; padding: 0; display: flex; overflow: hidden;">
                            <iframe 
                                src="/extensions/webview/browser.html" 
                                style="border: none; width: 100%; height: 100%; flex: 1; border-radius: 8px;" 
                                title="Navigateur web intégré">
                            </iframe>
                        </div>
                    `;
                    break;
            }
        }

        function setupChatListeners() {
            const messageInput = document.getElementById('messageInput');
            const sendButton = document.getElementById('sendButton');
            
            if (sendButton) {
                sendButton.addEventListener('click', sendMessage);
                console.log('Send button listener ajouté');
            }
            if (messageInput) {
                messageInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        sendMessage();
                    }
                });
                setTimeout(() => messageInput.focus(), 100);
            }
        }
        
        function initializeInterface() {
            console.log('Interface initialisée');
            // L'interface chat est déjà présente par défaut
        }
        
        // === FONCTIONS D'AIDE API ===
        let currentAuthToken = null;
        
        async function getAuthToken() {
            if (currentAuthToken) return currentAuthToken;
            
            try {
                const response = await fetch('/api/auth/token', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ client_type: 'webview' })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    currentAuthToken = data.token;
                    return currentAuthToken;
                }
            } catch (error) {
                console.error('Erreur authentification:', error);
            }
            return null;
        }
        
        async function sendAPIMessage(message) {
            const token = await getAuthToken();
            
            try {
                const response = await fetch('/api/chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-API-Key': token || 'development'
                    },
                    body: JSON.stringify({
                        message: message,
                        projectPath: currentWorkingDirectory,
                        blind: false
                    })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    showAPIMessage(data.response || 'Action exécutée avec succès', 'success');
                    return data;
                } else {
                    showAPIMessage('Erreur lors de l\'exécution', 'error');
                }
            } catch (error) {
                console.error('Erreur API:', error);
                showAPIMessage('Erreur de communication avec le serveur', 'error');
            }
        }
        
        async function createFileViaAPI(fileName, description) {
            const message = `${description}: ${fileName}`;
            return await sendAPIMessage(message);
        }
        
        async function executeQueryViaAPI(query) {
            const message = `Exécute la requête SQL suivante: ${query}`;
            return await sendAPIMessage(message);
        }
        
        // Fonction pour normaliser les chemins relatifs
        function normalizeRelativePath(path) {
            // Nettoyer le chemin
            let cleanPath = path.trim();
            if (cleanPath === '' || cleanPath === '/') return '.';
            
            // Supprimer les slashes de début et fin
            cleanPath = cleanPath.replace(/^\/+|\/+$/g, '');
            if (cleanPath === '') return '.';
            
            // Diviser en segments
            const segments = cleanPath.split('/').filter(segment => segment !== '' && segment !== '.');
            const normalizedSegments = [];
            
            // Traiter chaque segment
            for (const segment of segments) {
                if (segment === '..') {
                    // Remonter d'un niveau seulement si possible
                    if (normalizedSegments.length > 0) {
                        normalizedSegments.pop();
                    }
                    // Si on ne peut pas remonter plus, ignorer le '..'
                } else {
                    normalizedSegments.push(segment);
                }
            }
            
            // Construire le chemin final relatif
            return normalizedSegments.length > 0 ? normalizedSegments.join('/') : '.';
        }

        // Fonction pour changer le dossier de projet
        async function changeProjectFolder(newPath) {
            try {
                // Normaliser le chemin pour qu'il reste relatif
                let cleanPath = normalizeRelativePath(newPath);
                
                console.log('🔄 Changement de dossier:', newPath, '→', cleanPath);
                
                // Test si le dossier existe via l'API files
                const response = await fetch(`/api/files/list?dir=${encodeURIComponent(cleanPath)}`, {
                    headers: {
                        'X-API-Key': await getAuthToken() || 'development'
                    }
                });
                
                if (response.ok) {
                    // CHANGEMENT GLOBAL: Mettre à jour le dossier de travail pour TOUTES les vues
                    currentWorkingDirectory = cleanPath;
                    
                    // Mettre à jour l'interface Files
                    const folderPathInput = document.getElementById('folderPathInput');
                    const currentFolderDisplay = document.getElementById('currentFolderDisplay');
                    
                    if (folderPathInput) folderPathInput.value = cleanPath;
                    if (currentFolderDisplay) currentFolderDisplay.textContent = cleanPath;
                    
                    // Rafraîchir la liste des fichiers 
                    const fileTreeElement = document.getElementById('fileTree');
                    if (fileTreeElement) {
                        await loadFileTreeForDirectory(cleanPath);
                    }
                    
                    // Notifier toutes les autres vues du changement
                    await notifyViewsOfDirectoryChange(cleanPath);
                    
                    showAPIMessage(`📁 Dossier global changé vers: ${cleanPath} (toutes vues mises à jour)`, 'success');
                } else {
                    throw new Error(`Dossier inaccessible: ${cleanPath}`);
                }
            } catch (error) {
                console.error('Erreur changement de dossier:', error);
                showAPIMessage(`Erreur: ${error.message}`, 'error');
            }
        }
        
        function showAPIMessage(text, type = 'info') {
            const messagesContainer = document.getElementById('messages');
            if (!messagesContainer) return;
            
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message assistant-message';
            
            const icon = type === 'success' ? '✅' : type === 'error' ? '❌' : type === 'warning' ? '⚠️' : 'ℹ️';
            const color = type === 'success' ? 'var(--primary)' : type === 'error' ? '#ff6b6b' : type === 'warning' ? '#ffa726' : 'var(--muted-foreground)';
            
            messageDiv.innerHTML = `
                <div style="color: ${color}; margin-bottom: 0.5rem;">
                    <strong>${icon} SGC-AgentOne</strong>
                </div>
                <div>${text}</div>
            `;
            
            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }
        
        // === FONCTION MODERNE POUR REMPLACER PROMPT() ===
        function showModernFileDialog(title, placeholder, callback) {
            // Créer modal moderne au lieu de prompt() primitif
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed; top: 0; left: 0; width: 100%; height: 100%;
                background: rgba(0,0,0,0.5); z-index: 1000; display: flex;
                align-items: center; justify-content: center;
            `;
            
            modal.innerHTML = `
                <div style="
                    background: var(--background); border-radius: 12px; padding: 2rem;
                    box-shadow: 0 4px 20px rgba(0,0,0,0.3); max-width: 400px; width: 90%;
                    border: 1px solid var(--border);
                ">
                    <h3 style="margin: 0 0 1rem 0; color: var(--foreground);">${title}</h3>
                    <input type="text" id="fileNameInput" placeholder="${placeholder}" 
                           style="width: 100%; padding: 0.75rem; border: 1px solid var(--border);
                                  border-radius: 6px; background: var(--secondary); color: var(--foreground);
                                  font-family: inherit; margin-bottom: 1rem;" value="${placeholder}">
                    <div style="display: flex; gap: 0.5rem; justify-content: flex-end;">
                        <button id="cancelBtn" style="
                            padding: 0.5rem 1rem; border: 1px solid var(--border);
                            background: var(--secondary); color: var(--foreground);
                            border-radius: 6px; cursor: pointer;
                        ">Annuler</button>
                        <button id="confirmBtn" style="
                            padding: 0.5rem 1rem; border: none;
                            background: var(--primary); color: var(--primary-foreground);
                            border-radius: 6px; cursor: pointer;
                        ">Créer</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            const input = modal.querySelector('#fileNameInput');
            const confirmBtn = modal.querySelector('#confirmBtn');
            const cancelBtn = modal.querySelector('#cancelBtn');
            
            // Focus et sélection
            input.focus();
            input.select();
            
            // Events
            confirmBtn.onclick = () => {
                const fileName = input.value.trim();
                if (fileName) {
                    callback(fileName);
                }
                document.body.removeChild(modal);
            };
            
            cancelBtn.onclick = () => {
                document.body.removeChild(modal);
            };
            
            // Enter pour confirmer
            input.onkeypress = (e) => {
                if (e.key === 'Enter') {
                    confirmBtn.click();
                }
            };
            
            // Échap pour annuler
            modal.onkeydown = (e) => {
                if (e.key === 'Escape') {
                    cancelBtn.click();
                }
            };
        }
        
        // === FONCTIONS POUR LA VUE FICHIERS ===
        function setupFilesListeners() {
            console.log('Setup files listeners');
            
            // Boutons principaux
            const createFileBtn = document.getElementById('createFileBtn');
            const refreshFilesBtn = document.getElementById('refreshFilesBtn');
            
            if (createFileBtn) {
                createFileBtn.addEventListener('click', async () => {
                    showModernFileDialog('Créer un nouveau fichier', 'nouveau_fichier.txt', async (fileName) => {
                        await createFileViaAPI(fileName, 'Créer un nouveau fichier');
                    });
                });
            }
            
            if (refreshFilesBtn) {
                refreshFilesBtn.addEventListener('click', async () => {
                    console.log('Actualisation de l\'arborescence');
                    await sendAPIMessage('Actualise la liste des fichiers du projet');
                });
            }
            
            // Boutons de navigation de dossier
            const changeFolderBtn = document.getElementById('changeFolderBtn');
            const parentFolderBtn = document.getElementById('parentFolderBtn');
            const homeFolderBtn = document.getElementById('homeFolderBtn');
            const folderPathInput = document.getElementById('folderPathInput');
            const currentFolderDisplay = document.getElementById('currentFolderDisplay');
            
            if (changeFolderBtn && folderPathInput) {
                changeFolderBtn.addEventListener('click', async () => {
                    const newPath = folderPathInput.value.trim();
                    if (newPath) {
                        await changeProjectFolder(newPath);
                    }
                });
                
                // Permettre l'utilisation d'Entrée pour changer de dossier
                folderPathInput.addEventListener('keypress', async (e) => {
                    if (e.key === 'Enter') {
                        const newPath = folderPathInput.value.trim();
                        if (newPath) {
                            await changeProjectFolder(newPath);
                        }
                    }
                });
            }
            
            if (parentFolderBtn) {
                parentFolderBtn.addEventListener('click', async () => {
                    const currentPath = currentWorkingDirectory || '.';
                    console.log('🔼 Navigation parent depuis:', currentPath);
                    
                    // Calculer le dossier parent de manière relative
                    if (currentPath === '.') {
                        // Déjà à la racine, ne rien faire
                        showAPIMessage('⚠️ Déjà à la racine du projet', 'warning');
                        return;
                    }
                    
                    // Remonter d'un niveau
                    const pathSegments = currentPath.split('/').filter(s => s !== '' && s !== '.');
                    pathSegments.pop(); // Enlever le dernier segment
                    const parentPath = pathSegments.length > 0 ? pathSegments.join('/') : '.';
                    
                    await changeProjectFolder(parentPath);
                });
            }
            
            if (homeFolderBtn) {
                homeFolderBtn.addEventListener('click', async () => {
                    await changeProjectFolder('.');
                });
            }
            
            // Actions rapides
            const createHtmlBtn = document.getElementById('createHtmlBtn');
            const createCssBtn = document.getElementById('createCssBtn');
            const createJsBtn = document.getElementById('createJsBtn');
            const createPhpBtn = document.getElementById('createPhpBtn');
            
            if (createHtmlBtn) {
                createHtmlBtn.addEventListener('click', async () => {
                    showModernFileDialog('Créer un fichier HTML', 'index.html', async (fileName) => {
                        await createFileViaAPI(fileName, 'Créer un fichier HTML avec template de base');
                    });
                });
            }
            
            if (createCssBtn) {
                createCssBtn.addEventListener('click', async () => {
                    showModernFileDialog('Créer un fichier CSS', 'style.css', async (fileName) => {
                        await createFileViaAPI(fileName, 'Créer un fichier CSS avec template de base');
                    });
                });
            }
            
            if (createJsBtn) {
                createJsBtn.addEventListener('click', async () => {
                    showModernFileDialog('Créer un fichier JavaScript', 'script.js', async (fileName) => {
                        await createFileViaAPI(fileName, 'Créer un fichier JavaScript avec template de base');
                    });
                });
            }
            
            if (createPhpBtn) {
                createPhpBtn.addEventListener('click', async () => {
                    showModernFileDialog('Créer un fichier PHP', 'script.php', async (fileName) => {
                        await createFileViaAPI(fileName, 'Créer un fichier PHP avec template de base');
                    });
                });
            }
            
            // Interactivité arborescence
            document.querySelectorAll('.file-item').forEach(item => {
                item.addEventListener('click', () => {
                    item.style.background = 'var(--secondary)';
                    setTimeout(() => {
                        item.style.background = '';
                    }, 200);
                });
            });
        }
        
        // === FONCTIONS POUR LA VUE BASE DE DONNÉES ===
        function setupDatabaseListeners() {
            console.log('Setup database listeners');
            const connectDbBtn = document.getElementById('connectDbBtn');
            const createTableBtn = document.getElementById('createTableBtn');
            const executeQueryBtn = document.getElementById('executeQueryBtn');
            const clearQueryBtn = document.getElementById('clearQueryBtn');
            const sqlEditor = document.getElementById('sqlEditor');
            
            if (connectDbBtn) {
                connectDbBtn.addEventListener('click', async () => {
                    console.log('Connexion base de données');
                    await sendAPIMessage('Vérifie la connexion à la base de données SQLite et affiche les tables existantes');
                });
            }
            
            if (createTableBtn) {
                createTableBtn.addEventListener('click', () => {
                    showModernFileDialog('Créer une nouvelle table', 'ma_table', (tableName) => {
                        const sql = `CREATE TABLE ${tableName} (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    nom TEXT NOT NULL,
    email TEXT UNIQUE,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP
);`;
                        sqlEditor.value = sql;
                        console.log('Template table créé:', tableName);
                    });
                });
            }
            
            if (executeQueryBtn) {
                executeQueryBtn.addEventListener('click', async () => {
                    const query = sqlEditor.value.trim();
                    if (query) {
                        console.log('Exécution requête:', query);
                        await executeQueryViaAPI(query);
                    } else {
                        showAPIMessage('Veuillez saisir une requête SQL', 'warning');
                    }
                });
            }
            
            if (clearQueryBtn) {
                clearQueryBtn.addEventListener('click', () => {
                    if (sqlEditor) {
                        sqlEditor.value = '';
                        sqlEditor.focus();
                    }
                });
            }
            
            // Select requêtes prédéfinies
            const predefinedSelect = document.querySelector('select');
            if (predefinedSelect) {
                predefinedSelect.addEventListener('change', (e) => {
                    if (e.target.value && sqlEditor) {
                        const queries = {
                            'tables': "SELECT name FROM sqlite_master WHERE type='table';",
                            'users': 'CREATE TABLE users (id INTEGER PRIMARY KEY, nom TEXT, email TEXT);',
                            'insert': "INSERT INTO users (nom, email) VALUES ('John Doe', 'john@example.com');"
                        };
                        sqlEditor.value = queries[e.target.value] || '';
                    }
                });
            }
        }
        
        // === DÉFINITIONS DES THÈMES ===
        const themes = {
            commander: {
                name: 'SGC-Commander',
                vars: {
                    '--background': 'hsl(222, 84%, 5%)',
                    '--foreground': 'hsl(210, 40%, 95%)',
                    '--card': 'hsl(215, 28%, 17%)',
                    '--primary': 'hsl(188, 95%, 42%)',
                    '--primary-foreground': 'hsl(222, 84%, 5%)',
                    '--secondary': 'hsl(215, 16%, 25%)',
                    '--accent': 'hsl(188, 95%, 42%)',
                    '--border': 'hsl(217, 19%, 20%)',
                    '--muted-foreground': 'hsl(217, 10%, 58%)'
                }
            },
            dark: {
                name: 'Sombre classique',
                vars: {
                    '--background': 'hsl(0, 0%, 8%)',
                    '--foreground': 'hsl(0, 0%, 95%)',
                    '--card': 'hsl(0, 0%, 14%)',
                    '--primary': 'hsl(210, 95%, 50%)',
                    '--primary-foreground': 'hsl(0, 0%, 98%)',
                    '--secondary': 'hsl(0, 0%, 20%)',
                    '--accent': 'hsl(210, 95%, 50%)',
                    '--border': 'hsl(0, 0%, 25%)',
                    '--muted-foreground': 'hsl(0, 0%, 65%)'
                }
            },
            light: {
                name: 'Clair',
                vars: {
                    '--background': 'hsl(0, 0%, 98%)',
                    '--foreground': 'hsl(0, 0%, 5%)',
                    '--card': 'hsl(0, 0%, 95%)',
                    '--primary': 'hsl(210, 95%, 45%)',
                    '--primary-foreground': 'hsl(0, 0%, 98%)',
                    '--secondary': 'hsl(0, 0%, 90%)',
                    '--accent': 'hsl(210, 95%, 45%)',
                    '--border': 'hsl(0, 0%, 85%)',
                    '--muted-foreground': 'hsl(0, 0%, 45%)'
                }
            }
        };
        
        // === FONCTION D'APPLICATION DES THÈMES ===
        function applyTheme(themeKey) {
            const theme = themes[themeKey];
            if (!theme) return;
            
            const root = document.documentElement;
            Object.entries(theme.vars).forEach(([prop, value]) => {
                root.style.setProperty(prop, value);
            });
            
            console.log(`Thème appliqué: ${theme.name}`);
            showAPIMessage(`Thème "${theme.name}" activé !`, 'success');
        }

        // === FONCTIONS POUR LA VUE PARAMÈTRES ===
        function setupSettingsListeners() {
            console.log('Setup settings listeners');
            // Boutons de thème
            const themeButtons = document.querySelectorAll('[id*="theme"]');
            themeButtons.forEach(btn => {
                btn.addEventListener('click', () => {
                    themeButtons.forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    console.log('Thème changé:', btn.id);
                    
                    // Appliquer le thème correspondant
                    if (btn.id.includes('Commander')) {
                        applyTheme('commander');
                    } else if (btn.id.includes('Dark')) {
                        applyTheme('dark');
                    } else if (btn.id.includes('Light')) {
                        applyTheme('light');
                    }
                });
            });
            
            // Boutons d'action
            const regenerateApiBtn = document.getElementById('regenerateApiBtn');
            if (regenerateApiBtn) {
                regenerateApiBtn.addEventListener('click', async () => {
                    if (confirm('Regénérer la clé API ? Cela invalidera la clé actuelle.')) {
                        console.log('Regénération clé API');
                        await sendAPIMessage('Régénère une nouvelle clé API de sécurité');
                    }
                });
            }
            
            const exportConfigBtn = document.getElementById('exportConfigBtn');
            if (exportConfigBtn) {
                exportConfigBtn.addEventListener('click', async () => {
                    console.log('Export configuration');
                    await sendAPIMessage('Exporte la configuration actuelle vers un fichier sgc-config.json');
                });
            }
            
            const importConfigBtn = document.getElementById('importConfigBtn');
            if (importConfigBtn) {
                importConfigBtn.addEventListener('click', async () => {
                    console.log('Import configuration');
                    await sendAPIMessage('Importe une configuration depuis un fichier sgc-config.json');
                });
            }
            
            const clearLogsBtn = document.getElementById('clearLogsBtn');
            if (clearLogsBtn) {
                clearLogsBtn.addEventListener('click', async () => {
                    if (confirm('Vider tous les logs système ?')) {
                        console.log('Vidage des logs');
                        await sendAPIMessage('Vide tous les logs système et fichiers temporaires');
                    }
                });
            }
            
            const restartServerBtn = document.getElementById('restartServerBtn');
            if (restartServerBtn) {
                restartServerBtn.addEventListener('click', async () => {
                    if (confirm('Redémarrer le serveur SGC-AgentOne ?')) {
                        console.log('Redémarrage serveur');
                        await sendAPIMessage('Redémarre le serveur SGC-AgentOne');
                    }
                });
            }
            
            // Gestion des checkboxes
            document.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
                checkbox.addEventListener('change', (e) => {
                    console.log('Option changée:', e.target.nextElementSibling.textContent, 'Activé:', e.target.checked);
                });
            });
        }

        // === FONCTIONS POUR LA VUE PROMPTS ===
        function setupPromptsListeners() {
            console.log('Setup prompts listeners');
            
            // Variables globales pour la vue prompts
            let patterns = [];
            let filteredPatterns = [];
            
            // Chargement initial des patterns
            loadPatterns();
            
            // Event listeners pour la recherche et le filtrage
            const searchInput = document.getElementById('searchPatterns');
            const filterSelect = document.getElementById('filterAction');
            
            if (searchInput) {
                searchInput.addEventListener('input', (e) => {
                    filterPatterns();
                });
            }
            
            if (filterSelect) {
                filterSelect.addEventListener('change', (e) => {
                    filterPatterns();
                });
            }
            
            // Event listeners pour le formulaire nouveau pattern
            const newPatternInput = document.getElementById('newPattern');
            const newActionSelect = document.getElementById('newAction');
            const addPatternBtn = document.getElementById('addPatternBtn');
            const testPatternBtn = document.getElementById('testPatternBtn');
            
            if (addPatternBtn) {
                addPatternBtn.addEventListener('click', async () => {
                    await addNewPattern();
                });
            }
            
            if (testPatternBtn) {
                testPatternBtn.addEventListener('click', () => {
                    testCurrentPattern();
                });
            }
            
            // Event listener pour le testeur temps réel
            const testCommandInput = document.getElementById('testCommand');
            if (testCommandInput) {
                testCommandInput.addEventListener('input', (e) => {
                    testCommandRealTime(e.target.value);
                });
            }
            
            // Event listeners pour les boutons d'actions
            const refreshBtn = document.getElementById('refreshPatternsBtn');
            const exportBtn = document.getElementById('exportPatternsBtn');
            
            if (refreshBtn) {
                refreshBtn.addEventListener('click', () => {
                    loadPatterns();
                });
            }
            
            if (exportBtn) {
                exportBtn.addEventListener('click', () => {
                    exportPatterns();
                });
            }
            
            // Event listeners pour les templates rapides
            document.getElementById('templateCreateFile')?.addEventListener('click', () => {
                addTemplatePatterns('create');
            });
            
            document.getElementById('templateModifyFile')?.addEventListener('click', () => {
                addTemplatePatterns('modify');
            });
            
            document.getElementById('templateDatabase')?.addEventListener('click', () => {
                addTemplatePatterns('database');
            });
            
            document.getElementById('resetPatternsBtn')?.addEventListener('click', () => {
                if (confirm('Réinitialiser tous les patterns aux valeurs par défaut ?')) {
                    resetPatterns();
                }
            });
            
            // Fonctions internes
            async function loadPatterns() {
                try {
                    const response = await fetch('/api/prompts', {
                        headers: {
                            'X-API-Key': await getAuthToken() || 'development'
                        }
                    });
                    
                    if (response.ok) {
                        patterns = await response.json();
                        filteredPatterns = [...patterns];
                        updatePatternsDisplay();
                    } else {
                        // Fallback : afficher les patterns par défaut
                        showAPIMessage('Impossible de charger les patterns. Affichage des valeurs par défaut.', 'warning');
                        loadDefaultPatterns();
                    }
                } catch (error) {
                    console.error('Erreur chargement patterns:', error);
                    showAPIMessage('Erreur de connexion. Affichage des patterns par défaut.', 'error');
                    loadDefaultPatterns();
                }
            }
            
            function loadDefaultPatterns() {
                patterns = [
                    { pattern: "crée un fichier *", action: "create file" },
                    { pattern: "génère le fichier *", action: "create file" },
                    { pattern: "modifie le fichier *", action: "update file" },
                    { pattern: "lis le fichier *", action: "read file" },
                    { pattern: "connecte à la base *", action: "create database" },
                    { pattern: "exécute la requête *", action: "execute query" }
                ];
                filteredPatterns = [...patterns];
                updatePatternsDisplay();
            }
            
            function filterPatterns() {
                const searchTerm = searchInput?.value?.toLowerCase() || '';
                const actionFilter = filterSelect?.value || '';
                
                filteredPatterns = patterns.filter(pattern => {
                    const matchesSearch = pattern.pattern.toLowerCase().includes(searchTerm) || 
                                        pattern.action.toLowerCase().includes(searchTerm);
                    const matchesAction = !actionFilter || pattern.action === actionFilter;
                    return matchesSearch && matchesAction;
                });
                
                updatePatternsDisplay();
            }
            
            function updatePatternsDisplay() {
                const patternsList = document.getElementById('patternsList');
                const patternsCount = document.getElementById('patternsCount');
                
                if (patternsCount) {
                    patternsCount.textContent = filteredPatterns.length;
                }
                
                if (!patternsList) return;
                
                if (filteredPatterns.length === 0) {
                    patternsList.innerHTML = `
                        <div style="text-align: center; color: var(--muted-foreground); padding: 2rem;">
                            <i class="fas fa-search"></i> Aucun pattern trouvé
                        </div>
                    `;
                    return;
                }
                
                patternsList.innerHTML = filteredPatterns.map((pattern, index) => `
                    <div class="pattern-item clay-panel" style="padding: 1rem; margin-bottom: 0.5rem; display: flex; justify-content: space-between; align-items: center;">
                        <div style="flex: 1;">
                            <div style="font-family: 'JetBrains Mono', monospace; font-weight: 600; color: var(--primary);">
                                "${pattern.pattern}"
                            </div>
                            <div style="font-size: 0.8rem; color: var(--muted-foreground); margin-top: 0.25rem;">
                                → ${pattern.action}
                            </div>
                        </div>
                        <div style="display: flex; gap: 0.5rem;">
                            <button class="clay-button" onclick="editPattern(${index})" style="padding: 0.25rem 0.5rem; font-size: 0.8rem;">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="clay-button" onclick="deletePattern(${index})" style="padding: 0.25rem 0.5rem; font-size: 0.8rem;">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                `).join('');
            }
            
            async function addNewPattern() {
                const pattern = newPatternInput?.value?.trim();
                const action = newActionSelect?.value;
                
                if (!pattern || !action) {
                    showAPIMessage('Veuillez remplir le pattern et sélectionner une action', 'warning');
                    return;
                }
                
                if (patterns.some(p => p.pattern === pattern)) {
                    showAPIMessage('Ce pattern existe déjà', 'warning');
                    return;
                }
                
                try {
                    const response = await fetch('/api/prompts', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-API-Key': await getAuthToken() || 'development'
                        },
                        body: JSON.stringify({ pattern, action })
                    });
                    
                    if (response.ok) {
                        showAPIMessage('Pattern ajouté avec succès', 'success');
                        newPatternInput.value = '';
                        newActionSelect.value = '';
                        loadPatterns();
                    } else {
                        showAPIMessage('Erreur lors de l\'ajout du pattern', 'error');
                    }
                } catch (error) {
                    console.error('Erreur ajout pattern:', error);
                    showAPIMessage('Erreur de connexion', 'error');
                }
            }
            
            function testCurrentPattern() {
                const pattern = newPatternInput?.value?.trim();
                if (!pattern) {
                    showAPIMessage('Entrez un pattern à tester', 'warning');
                    return;
                }
                
                const testCommand = testCommandInput?.value?.trim() || 'test fichier exemple.txt';
                testCommandRealTime(testCommand, pattern);
            }
            
            function testCommandRealTime(command, customPattern = null) {
                const testResult = document.getElementById('testResult');
                if (!testResult) return;
                
                if (!command.trim()) {
                    testResult.innerHTML = `
                        <div style="color: var(--muted-foreground); text-align: center;">
                            Tapez une commande ci-dessus pour voir l'interprétation en temps réel...
                        </div>
                    `;
                    return;
                }
                
                // Simulation de l'interprétation (en attendant l'API backend)
                const testPatterns = customPattern ? 
                    [{ pattern: customPattern, action: newActionSelect?.value || 'create file' }] : 
                    patterns;
                
                let matchedPattern = null;
                for (const pattern of testPatterns) {
                    if (matchesPattern(command.toLowerCase(), pattern.pattern.toLowerCase())) {
                        matchedPattern = pattern;
                        break;
                    }
                }
                
                if (matchedPattern) {
                    const params = extractParametersFromCommand(command, matchedPattern.pattern);
                    testResult.innerHTML = `
                        <div style="color: var(--primary);">
                            <strong>✅ Correspondance trouvée</strong>
                        </div>
                        <div style="margin-top: 0.5rem;">
                            <strong>Pattern:</strong> "${matchedPattern.pattern}"
                        </div>
                        <div style="margin-top: 0.5rem;">
                            <strong>Action:</strong> ${matchedPattern.action}
                        </div>
                        <div style="margin-top: 0.5rem;">
                            <strong>Paramètres extraits:</strong> ${JSON.stringify(params)}
                        </div>
                    `;
                } else {
                    testResult.innerHTML = `
                        <div style="color: #ff6b6b;">
                            <strong>❌ Aucune correspondance</strong>
                        </div>
                        <div style="margin-top: 0.5rem; color: var(--muted-foreground);">
                            La commande "${command}" ne correspond à aucun pattern existant.
                        </div>
                    `;
                }
            }
            
            function matchesPattern(command, pattern) {
                // Simple pattern matching avec wildcards
                const regex = pattern.replace(/\*/g, '.*');
                return new RegExp(regex).test(command);
            }
            
            function extractParametersFromCommand(command, pattern) {
                const params = {};
                if (pattern.includes('*')) {
                    const regex = pattern.replace(/\*/g, '(.+)');
                    const match = command.match(new RegExp(regex));
                    if (match && match[1]) {
                        params.captured = match[1].trim();
                        // Tenter d'extraire un nom de fichier
                        if (match[1].includes('.')) {
                            params.filename = match[1].trim();
                        }
                    }
                }
                return params;
            }
            
            function exportPatterns() {
                const dataStr = JSON.stringify(patterns, null, 2);
                const blob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'sgc-patterns-export.json';
                a.click();
                URL.revokeObjectURL(url);
                showAPIMessage('Patterns exportés avec succès', 'success');
            }
            
            function addTemplatePatterns(type) {
                const templates = {
                    create: [
                        { pattern: "génère une API REST pour *", action: "create file" },
                        { pattern: "crée une page web *", action: "create file" },
                        { pattern: "ajoute un composant *", action: "create file" }
                    ],
                    modify: [
                        { pattern: "ajoute la fonction * au fichier *", action: "update file" },
                        { pattern: "corrige le fichier *", action: "update file" },
                        { pattern: "optimise le code de *", action: "update file" }
                    ],
                    database: [
                        { pattern: "crée une table * avec les colonnes *", action: "execute query" },
                        { pattern: "ajoute des données à la table *", action: "execute query" },
                        { pattern: "sauvegarde la base dans *", action: "execute query" }
                    ]
                };
                
                const newPatternInput = document.getElementById('newPattern');
                const newActionSelect = document.getElementById('newAction');
                
                if (templates[type] && newPatternInput && newActionSelect) {
                    const template = templates[type][0]; // Prendre le premier template
                    newPatternInput.value = template.pattern;
                    newActionSelect.value = template.action;
                    showAPIMessage(`Template "${type}" chargé`, 'success');
                }
            }
            
            async function resetPatterns() {
                try {
                    const response = await fetch('/api/prompts/reset', {
                        method: 'POST',
                        headers: {
                            'X-API-Key': await getAuthToken() || 'development'
                        }
                    });
                    
                    if (response.ok) {
                        showAPIMessage('Patterns réinitialisés aux valeurs par défaut', 'success');
                        loadPatterns();
                    } else {
                        showAPIMessage('Erreur lors de la réinitialisation', 'error');
                    }
                } catch (error) {
                    console.error('Erreur reset patterns:', error);
                    loadDefaultPatterns();
                    showAPIMessage('Patterns réinitialisés localement', 'warning');
                }
            }
            
            // Fonctions globales pour les boutons inline
            window.editPattern = function(index) {
                const pattern = filteredPatterns[index];
                if (pattern) {
                    const newPatternInput = document.getElementById('newPattern');
                    const newActionSelect = document.getElementById('newAction');
                    if (newPatternInput && newActionSelect) {
                        newPatternInput.value = pattern.pattern;
                        newActionSelect.value = pattern.action;
                        showAPIMessage('Pattern chargé dans le formulaire', 'info');
                    }
                }
            };
            
            window.deletePattern = async function(index) {
                const pattern = filteredPatterns[index];
                if (!pattern) return;
                
                if (!confirm(`Supprimer le pattern "${pattern.pattern}" ?`)) return;
                
                try {
                    const response = await fetch(`/api/prompts/${encodeURIComponent(pattern.pattern)}`, {
                        method: 'DELETE',
                        headers: {
                            'X-API-Key': await getAuthToken() || 'development'
                        }
                    });
                    
                    if (response.ok) {
                        showAPIMessage('Pattern supprimé avec succès', 'success');
                        loadPatterns();
                    } else {
                        showAPIMessage('Erreur lors de la suppression', 'error');
                    }
                } catch (error) {
                    console.error('Erreur suppression pattern:', error);
                    showAPIMessage('Erreur de connexion', 'error');
                }
            };
        }

        // === FONCTIONS POUR LA VUE SERVER ===
        function setupServerListeners() {
            console.log('Setup server listeners');
            
            // Variables globales pour le monitoring
            let serverData = {};
            let updateInterval = null;
            let logsPollingInterval = null;
            
            // Chargement initial des données serveur
            loadServerData();
            startRealTimeMonitoring();
            
            // Event listeners pour les contrôles
            const refreshServerBtn = document.getElementById('refreshServerBtn');
            const serverRestartBtn = document.getElementById('serverRestartBtn');
            const serverStopBtn = document.getElementById('serverStopBtn');
            const serverHealthBtn = document.getElementById('serverHealthBtn');
            const changePortBtn = document.getElementById('changePortBtn');
            const flushCacheBtn = document.getElementById('flushCacheBtn');
            
            if (refreshServerBtn) {
                refreshServerBtn.addEventListener('click', () => {
                    loadServerData();
                    showAPIMessage('Données serveur actualisées', 'success');
                });
            }
            
            if (serverRestartBtn) {
                serverRestartBtn.addEventListener('click', async () => {
                    if (confirm('Redémarrer le serveur SGC-AgentOne ? Cela peut prendre quelques secondes.')) {
                        await performServerAction('restart');
                    }
                });
            }
            
            if (serverStopBtn) {
                serverStopBtn.addEventListener('click', async () => {
                    if (confirm('⚠️ ATTENTION: Arrêter le serveur fermera cette interface. Continuer ?')) {
                        await performServerAction('stop');
                    }
                });
            }
            
            if (serverHealthBtn) {
                serverHealthBtn.addEventListener('click', async () => {
                    await performServerAction('health');
                });
            }
            
            if (changePortBtn) {
                changePortBtn.addEventListener('click', async () => {
                    const newPort = document.getElementById('newPortInput')?.value;
                    if (newPort && newPort !== '5000') {
                        if (confirm(`Changer le port vers ${newPort} ? Le serveur redémarrera automatiquement.`)) {
                            await performServerAction('changePort', { port: parseInt(newPort) });
                        }
                    }
                });
            }
            
            if (flushCacheBtn) {
                flushCacheBtn.addEventListener('click', async () => {
                    await performServerAction('flushCache');
                });
            }
            
            // Event listeners pour les logs
            const clearLogsDisplayBtn = document.getElementById('clearLogsDisplayBtn');
            const exportLogsBtn = document.getElementById('exportLogsBtn');
            const logFilter = document.getElementById('logFilter');
            
            if (clearLogsDisplayBtn) {
                clearLogsDisplayBtn.addEventListener('click', () => {
                    const logsContainer = document.getElementById('liveLogsContainer');
                    if (logsContainer) {
                        logsContainer.innerHTML = `
                            <div style="color: var(--muted-foreground); text-align: center; padding: 2rem;">
                                <i class="fas fa-broom"></i> Logs effacés - en attente de nouvelles données...
                            </div>
                        `;
                    }
                });
            }
            
            if (exportLogsBtn) {
                exportLogsBtn.addEventListener('click', () => {
                    exportServerLogs();
                });
            }
            
            if (logFilter) {
                logFilter.addEventListener('change', (e) => {
                    filterDisplayedLogs(e.target.value);
                });
            }
            
            // Event listeners pour la configuration
            const applyConfigBtn = document.getElementById('applyConfigBtn');
            const resetConfigBtn = document.getElementById('resetConfigBtn');
            const exportServerConfigBtn = document.getElementById('exportServerConfigBtn');
            
            if (applyConfigBtn) {
                applyConfigBtn.addEventListener('click', async () => {
                    await applyServerConfiguration();
                });
            }
            
            if (resetConfigBtn) {
                resetConfigBtn.addEventListener('click', async () => {
                    if (confirm('Réinitialiser la configuration serveur aux valeurs par défaut ?')) {
                        await resetServerConfiguration();
                    }
                });
            }
            
            if (exportServerConfigBtn) {
                exportServerConfigBtn.addEventListener('click', () => {
                    exportServerConfiguration();
                });
            }
            
            // === FONCTIONS INTERNES ===
            
            async function loadServerData() {
                try {
                    const response = await fetch('/api/server/status', {
                        headers: {
                            'X-API-Key': await getAuthToken() || 'development'
                        }
                    });
                    
                    if (response.ok) {
                        serverData = await response.json();
                        updateServerDisplay();
                    } else {
                        // Fallback avec données simulées
                        serverData = getSimulatedServerData();
                        updateServerDisplay();
                        showAPIMessage('Mode simulation - Données serveur fictives', 'warning');
                    }
                } catch (error) {
                    console.error('Erreur chargement données serveur:', error);
                    serverData = getSimulatedServerData();
                    updateServerDisplay();
                    showAPIMessage('Mode offline - Données simulées', 'error');
                }
            }
            
            function getSimulatedServerData() {
                const startTime = Date.now() - (45 * 60 * 1000); // 45 minutes ago
                return {
                    uptime: Math.floor((Date.now() - startTime) / 1000),
                    port: 5000,
                    pid: 12345,
                    memory: 28,
                    requestsPerSecond: Math.floor(Math.random() * 5) + 1,
                    activeConnections: Math.floor(Math.random() * 3) + 1,
                    totalRequests: 156 + Math.floor(Math.random() * 50),
                    status: 'running',
                    topRoutes: [
                        { route: '/api/chat', count: 45 + Math.floor(Math.random() * 20) },
                        { route: '/api/prompts', count: 23 + Math.floor(Math.random() * 15) },
                        { route: '/api/auth/token', count: 12 + Math.floor(Math.random() * 8) }
                    ]
                };
            }
            
            function updateServerDisplay() {
                // Mise à jour de l'uptime
                const uptimeElement = document.getElementById('serverUptime');
                if (uptimeElement && serverData.uptime) {
                    const hours = Math.floor(serverData.uptime / 3600);
                    const minutes = Math.floor((serverData.uptime % 3600) / 60);
                    const seconds = serverData.uptime % 60;
                    uptimeElement.textContent = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                }
                
                // Mise à jour des autres métriques
                const elements = {
                    'serverPort': serverData.port || 5000,
                    'serverPID': serverData.pid || '--',
                    'memoryUsage': serverData.memory ? `${serverData.memory} MB` : '-- MB',
                    'requestsPerSec': serverData.requestsPerSecond || 0,
                    'activeConnections': serverData.activeConnections || 0,
                    'totalRequests': serverData.totalRequests || 0
                };
                
                Object.entries(elements).forEach(([id, value]) => {
                    const element = document.getElementById(id);
                    if (element) element.textContent = value;
                });
                
                // Mise à jour du statut
                const statusElement = document.getElementById('serverStatus');
                if (statusElement) {
                    const isRunning = serverData.status === 'running';
                    statusElement.innerHTML = `
                        <i class="fas fa-circle"></i> ${isRunning ? 'EN LIGNE' : 'ARRÊTÉ'}
                    `;
                    statusElement.style.background = isRunning ? 'var(--primary)' : '#ff6b6b';
                }
                
                // Mise à jour des routes populaires
                if (serverData.topRoutes) {
                    const topRoutesElement = document.getElementById('topRoutes');
                    if (topRoutesElement) {
                        topRoutesElement.innerHTML = serverData.topRoutes
                            .map(route => `<div>${route.route} - ${route.count} appels</div>`)
                            .join('');
                    }
                }
                
                // Mise à jour du port dans les inputs
                const portInput = document.getElementById('newPortInput');
                if (portInput && !portInput.value.includes(serverData.port)) {
                    portInput.value = serverData.port || 5000;
                }
            }
            
            function startRealTimeMonitoring() {
                // Actualisation toutes les 3 secondes
                updateInterval = setInterval(() => {
                    loadServerData();
                }, 3000);
                
                // Polling des logs toutes les 2 secondes
                logsPollingInterval = setInterval(() => {
                    updateLiveLogs();
                }, 2000);
                
                // Nettoyage quand on change d'onglet
                window.addEventListener('beforeunload', () => {
                    if (updateInterval) clearInterval(updateInterval);
                    if (logsPollingInterval) clearInterval(logsPollingInterval);
                });
            }
            
            async function updateLiveLogs() {
                try {
                    const response = await fetch('/api/server/logs', {
                        headers: {
                            'X-API-Key': await getAuthToken() || 'development'
                        }
                    });
                    
                    if (response.ok) {
                        const logs = await response.json();
                        displayLiveLogs(logs);
                    } else {
                        // Fallback avec logs simulés
                        displaySimulatedLogs();
                    }
                } catch (error) {
                    displaySimulatedLogs();
                }
            }
            
            function displayLiveLogs(logs = []) {
                const logsContainer = document.getElementById('liveLogsContainer');
                const autoScroll = document.getElementById('autoScroll');
                
                if (!logsContainer) return;
                
                // Si pas de logs réels, utiliser logs simulés
                if (logs.length === 0) {
                    displaySimulatedLogs();
                    return;
                }
                
                const logLines = logs.map(log => {
                    const timestamp = new Date(log.timestamp).toLocaleTimeString();
                    const color = getLogColor(log.level);
                    return `<div style="color: ${color};">[${timestamp}] ${log.message}</div>`;
                }).join('');
                
                logsContainer.innerHTML = logLines;
                
                // Auto-scroll si activé
                if (autoScroll && autoScroll.checked) {
                    logsContainer.scrollTop = logsContainer.scrollHeight;
                }
                
                // Mise à jour du timestamp
                const lastUpdate = document.getElementById('lastLogUpdate');
                if (lastUpdate) {
                    lastUpdate.textContent = new Date().toLocaleTimeString();
                }
            }
            
            function displaySimulatedLogs() {
                const logsContainer = document.getElementById('liveLogsContainer');
                if (!logsContainer) return;
                
                const timestamp = new Date().toLocaleTimeString();
                const simulatedLogs = [
                    `<div style="color: var(--primary);">[${timestamp}] Serveur SGC-AgentOne actif</div>`,
                    `<div>[${timestamp}] Écoute sur port ${serverData.port || 5000}</div>`,
                    `<div>[${timestamp}] ${serverData.totalRequests || 0} requêtes traitées</div>`,
                    `<div style="color: #4ade80;">[${timestamp}] ✅ Système stable</div>`,
                    `<div style="color: var(--muted-foreground);">[${timestamp}] Mémoire: ${serverData.memory || 28} MB</div>`
                ];
                
                // Ajouter quelques logs aléatoires
                if (Math.random() > 0.7) {
                    const routes = ['/api/chat', '/api/prompts', '/api/server/status'];
                    const route = routes[Math.floor(Math.random() * routes.length)];
                    simulatedLogs.push(`<div>[${timestamp}] GET ${route} - 200 OK</div>`);
                }
                
                logsContainer.innerHTML = simulatedLogs.join('');
                
                // Auto-scroll
                const autoScroll = document.getElementById('autoScroll');
                if (autoScroll && autoScroll.checked) {
                    logsContainer.scrollTop = logsContainer.scrollHeight;
                }
            }
            
            function getLogColor(level) {
                switch(level) {
                    case 'error': return '#ff6b6b';
                    case 'warning': return '#ffa726';
                    case 'info': return 'var(--primary)';
                    case 'debug': return 'var(--muted-foreground)';
                    default: return 'var(--foreground)';
                }
            }
            
            function filterDisplayedLogs(filter) {
                const logsContainer = document.getElementById('liveLogsContainer');
                if (!logsContainer) return;
                
                const allLogs = logsContainer.querySelectorAll('div');
                allLogs.forEach(log => {
                    if (filter === 'all') {
                        log.style.display = 'block';
                    } else {
                        const shouldShow = log.textContent.toLowerCase().includes(filter.toLowerCase());
                        log.style.display = shouldShow ? 'block' : 'none';
                    }
                });
            }
            
            async function performServerAction(action, params = {}) {
                try {
                    const response = await fetch(`/api/server/control`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-API-Key': await getAuthToken() || 'development'
                        },
                        body: JSON.stringify({ action, ...params })
                    });
                    
                    if (response.ok) {
                        const result = await response.json();
                        showAPIMessage(result.message || `Action "${action}" exécutée`, 'success');
                        
                        // Actions spéciales
                        if (action === 'stop') {
                            setTimeout(() => {
                                showAPIMessage('Serveur arrêté - Interface sera indisponible', 'warning');
                            }, 1000);
                        } else if (action === 'restart' || action === 'changePort') {
                            showAPIMessage('Redémarrage en cours... Actualisation dans 3 secondes', 'info');
                            setTimeout(() => {
                                if (action === 'changePort' && params.port) {
                                    window.location.href = `http://localhost:${params.port}${window.location.pathname}`;
                                } else {
                                    window.location.reload();
                                }
                            }, 3000);
                        }
                        
                        // Actualiser les données après l'action
                        setTimeout(() => loadServerData(), 1000);
                    } else {
                        showAPIMessage(`Erreur lors de l'action "${action}"`, 'error');
                    }
                } catch (error) {
                    console.error(`Erreur action serveur ${action}:`, error);
                    showAPIMessage(`Action "${action}" simulée (mode offline)`, 'warning');
                }
            }
            
            function exportServerLogs() {
                const logsContainer = document.getElementById('liveLogsContainer');
                if (!logsContainer) return;
                
                const logs = Array.from(logsContainer.children)
                    .map(log => log.textContent)
                    .join('\n');
                
                const blob = new Blob([logs], { type: 'text/plain' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `sgc-server-logs-${new Date().toISOString().slice(0,19).replace(/:/g,'-')}.txt`;
                a.click();
                URL.revokeObjectURL(url);
                showAPIMessage('Logs exportés avec succès', 'success');
            }
            
            async function applyServerConfiguration() {
                const config = {
                    memoryLimit: document.getElementById('memoryLimitSelect')?.value || '256M',
                    timeout: document.getElementById('timeoutInput')?.value || 30,
                    debugMode: document.getElementById('debugModeToggle')?.checked || false
                };
                
                try {
                    const response = await fetch('/api/server/config', {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-API-Key': await getAuthToken() || 'development'
                        },
                        body: JSON.stringify(config)
                    });
                    
                    if (response.ok) {
                        showAPIMessage('Configuration appliquée avec succès', 'success');
                        loadServerData();
                    } else {
                        showAPIMessage('Configuration appliquée (mode simulation)', 'warning');
                    }
                } catch (error) {
                    showAPIMessage('Configuration sauvegardée localement', 'info');
                }
            }
            
            async function resetServerConfiguration() {
                // Reset des valeurs par défaut
                const memorySelect = document.getElementById('memoryLimitSelect');
                const timeoutInput = document.getElementById('timeoutInput');
                const debugToggle = document.getElementById('debugModeToggle');
                
                if (memorySelect) memorySelect.value = '256M';
                if (timeoutInput) timeoutInput.value = '30';
                if (debugToggle) debugToggle.checked = false;
                
                showAPIMessage('Configuration réinitialisée aux valeurs par défaut', 'success');
            }
            
            function exportServerConfiguration() {
                const config = {
                    port: serverData.port || 5000,
                    memoryLimit: document.getElementById('memoryLimitSelect')?.value || '256M',
                    timeout: document.getElementById('timeoutInput')?.value || 30,
                    debugMode: document.getElementById('debugModeToggle')?.checked || false,
                    exportDate: new Date().toISOString()
                };
                
                const blob = new Blob([JSON.stringify(config, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'sgc-server-config.json';
                a.click();
                URL.revokeObjectURL(url);
                showAPIMessage('Configuration serveur exportée', 'success');
            }
        }

        // === FONCTIONS POUR L'ÉDITEUR MONACO ===
        let monacoEditor = null;
        let editorTabs = [];
        let activeTabIndex = 0;
        
        function loadMonacoEditor() {
            // Chargement de Monaco Editor via CDN
            const script = document.createElement('script');
            script.src = 'https://cdn.jsdelivr.net/npm/monaco-editor@0.41.0/min/vs/loader.js';
            script.onload = function() {
                require.config({ 
                    paths: { 
                        'vs': 'https://cdn.jsdelivr.net/npm/monaco-editor@0.41.0/min/vs' 
                    } 
                });
                require(['vs/editor/editor.main'], function() {
                    initializeMonacoEditor();
                });
            };
            document.head.appendChild(script);
        }
        
        function initializeMonacoEditor() {
            const container = document.getElementById('monacoEditor');
            if (!container) return;
            
            // Configuration du thème Monaco pour s'adapter au design SGC-Commander
            monaco.editor.defineTheme('sgc-dark', {
                base: 'vs-dark',
                inherit: true,
                rules: [
                    { token: '', foreground: 'e6e6e6' },
                    { token: 'keyword', foreground: '4fc3f7' },
                    { token: 'string', foreground: '4caf50' },
                    { token: 'number', foreground: 'ff9800' },
                    { token: 'comment', foreground: '757575' }
                ],
                colors: {
                    'editor.background': '#1a1a1a',
                    'editor.foreground': '#e6e6e6',
                    'editorLineNumber.foreground': '#4a4a4a',
                    'editorCursor.foreground': '#4fc3f7',
                    'editor.selectionBackground': '#264f78',
                    'editor.lineHighlightBackground': '#2a2a2a'
                }
            });
            
            // Initialisation de l'éditeur
            monacoEditor = monaco.editor.create(container, {
                value: '// Bienvenue dans l\'éditeur SGC-AgentOne!\n// Commencez à taper ou ouvrez un fichier...\n\nfunction hello() {\n    console.log("Hello from SGC-AgentOne!");\n}',
                language: 'javascript',
                theme: 'sgc-dark',
                fontSize: 14,
                lineNumbers: 'on',
                roundedSelection: false,
                scrollBeyondLastLine: false,
                readOnly: false,
                minimap: { enabled: true },
                automaticLayout: true,
                wordWrap: 'on',
                suggestOnTriggerCharacters: true,
                quickSuggestions: true,
                scrollbar: {
                    vertical: 'visible',
                    horizontal: 'visible'
                }
            });
            
            // Initialisation du premier onglet
            editorTabs = [{
                filename: 'untitled.js',
                language: 'javascript',
                content: monacoEditor.getValue(),
                modified: false
            }];
            
            // Event listeners pour Monaco
            setupMonacoListeners();
            
            // Event listeners pour l'interface
            setupEditorListeners();
            
            // Charger l'arbre de fichiers
            loadFileTree();
            
            console.log('Monaco Editor initialisé avec succès');
        }
        
        function setupMonacoListeners() {
            if (!monacoEditor) return;
            
            // Détection des changements
            monacoEditor.onDidChangeModelContent(() => {
                updateEditorStatus();
                markTabAsModified(activeTabIndex);
            });
            
            // Position du curseur
            monacoEditor.onDidChangeCursorPosition((e) => {
                document.getElementById('lineNumber').textContent = e.position.lineNumber;
                document.getElementById('columnNumber').textContent = e.position.column;
            });
            
            // Mise à jour initiale du statut
            updateEditorStatus();
        }
        
        function setupEditorListeners() {
            // Boutons de contrôle
            const newFileBtn = document.getElementById('newFileBtn');
            const openFileBtn = document.getElementById('openFileBtn');
            const saveFileBtn = document.getElementById('saveFileBtn');
            const languageSelect = document.getElementById('languageSelect');
            
            if (newFileBtn) {
                newFileBtn.addEventListener('click', createNewFile);
            }
            
            if (openFileBtn) {
                openFileBtn.addEventListener('click', openFileDialog);
            }
            
            if (saveFileBtn) {
                saveFileBtn.addEventListener('click', saveCurrentFile);
            }
            
            if (languageSelect) {
                languageSelect.addEventListener('change', (e) => {
                    changeLanguage(e.target.value);
                });
            }
            
            // Raccourcis clavier
            document.addEventListener('keydown', (e) => {
                if (e.ctrlKey || e.metaKey) {
                    switch(e.key) {
                        case 's':
                            e.preventDefault();
                            saveCurrentFile();
                            break;
                        case 'n':
                            e.preventDefault();
                            createNewFile();
                            break;
                        case 'o':
                            e.preventDefault();
                            openFileDialog();
                            break;
                    }
                }
            });
        }
        
        function updateEditorStatus() {
            if (!monacoEditor) return;
            
            const content = monacoEditor.getValue();
            const lineCount = monacoEditor.getModel().getLineCount();
            
            document.getElementById('fileSize').textContent = content.length;
            document.getElementById('editorStatus').textContent = 'Modifié';
            
            // Mise à jour du langage actuel
            const currentLang = monacoEditor.getModel().getLanguageId();
            document.getElementById('currentLanguage').textContent = 
                currentLang.charAt(0).toUpperCase() + currentLang.slice(1);
        }
        
        function createNewFile() {
            const filename = prompt('Nom du nouveau fichier:', 'untitled.js');
            if (!filename) return;
            
            const language = detectLanguageFromFilename(filename);
            
            // Ajouter un nouvel onglet
            const newTab = {
                filename: filename,
                language: language,
                content: '',
                modified: false
            };
            
            editorTabs.push(newTab);
            activeTabIndex = editorTabs.length - 1;
            
            // Mettre à jour l'éditeur
            monaco.editor.setModelLanguage(monacoEditor.getModel(), language);
            monacoEditor.setValue('');
            
            // Mettre à jour l'interface
            updateTabsDisplay();
            updateLanguageSelect(language);
            
            showAPIMessage(`Nouveau fichier créé: ${filename}`, 'success');
        }
        
        async function openFileDialog() {
            try {
                const response = await fetch('/api/files/list', {
                    headers: {
                        'X-API-Key': await getAuthToken() || 'development'
                    }
                });
                
                if (response.ok) {
                    const files = await response.json();
                    showFileSelectionDialog(files);
                } else {
                    // Fallback - laisser l'utilisateur entrer le nom du fichier
                    const filename = prompt('Entrez le chemin du fichier à ouvrir:');
                    if (filename) {
                        await openFile(filename);
                    }
                }
            } catch (error) {
                console.error('Erreur ouverture fichier:', error);
                const filename = prompt('Entrez le chemin du fichier à ouvrir:');
                if (filename) {
                    await openFile(filename);
                }
            }
        }
        
        function showFileSelectionDialog(files) {
            const fileList = files.map(file => `<div class="file-item" onclick="openFile('${file.path}')">${file.name}</div>`).join('');
            
            const dialog = document.createElement('div');
            dialog.style.cssText = `
                position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
                background: var(--card); border: 1px solid var(--border); border-radius: 8px;
                padding: 1rem; max-width: 400px; z-index: 1000;
                box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            `;
            dialog.innerHTML = `
                <h3>Ouvrir un fichier</h3>
                <div style="max-height: 300px; overflow-y: auto;">
                    ${fileList}
                </div>
                <button onclick="this.parentElement.remove()">Annuler</button>
            `;
            document.body.appendChild(dialog);
        }
        
        async function openFile(filepath) {
            try {
                const response = await fetch('/api/files/read', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-API-Key': await getAuthToken() || 'development'
                    },
                    body: JSON.stringify({ filepath: filepath })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    const language = detectLanguageFromFilename(filepath);
                    
                    // Créer ou réutiliser un onglet
                    const existingTabIndex = editorTabs.findIndex(tab => tab.filename === filepath);
                    
                    if (existingTabIndex >= 0) {
                        // Onglet existe déjà, l'activer
                        activeTabIndex = existingTabIndex;
                    } else {
                        // Créer un nouvel onglet
                        editorTabs.push({
                            filename: filepath,
                            language: language,
                            content: data.content,
                            modified: false
                        });
                        activeTabIndex = editorTabs.length - 1;
                    }
                    
                    // Mettre à jour l'éditeur
                    monaco.editor.setModelLanguage(monacoEditor.getModel(), language);
                    monacoEditor.setValue(data.content);
                    
                    // Mettre à jour l'interface
                    updateTabsDisplay();
                    updateLanguageSelect(language);
                    
                    showAPIMessage(`Fichier ouvert: ${filepath}`, 'success');
                } else {
                    showAPIMessage('Erreur lors de l\'ouverture du fichier', 'error');
                }
            } catch (error) {
                console.error('Erreur ouverture fichier:', error);
                showAPIMessage('Erreur de connexion', 'error');
            }
        }
        
        async function saveCurrentFile() {
            if (!monacoEditor || editorTabs.length === 0) return;
            
            const currentTab = editorTabs[activeTabIndex];
            const content = monacoEditor.getValue();
            
            try {
                const response = await fetch('/api/files/save', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-API-Key': await getAuthToken() || 'development'
                    },
                    body: JSON.stringify({
                        filepath: currentTab.filename,
                        content: content,
                        language: currentTab.language
                    })
                });
                
                if (response.ok) {
                    currentTab.content = content;
                    currentTab.modified = false;
                    updateTabsDisplay();
                    document.getElementById('editorStatus').textContent = 'Sauvegardé';
                    showAPIMessage(`Fichier sauvegardé: ${currentTab.filename}`, 'success');
                } else {
                    showAPIMessage('Erreur lors de la sauvegarde', 'error');
                }
            } catch (error) {
                console.error('Erreur sauvegarde:', error);
                showAPIMessage('Erreur de connexion', 'error');
            }
        }
        
        function changeLanguage(language) {
            if (!monacoEditor) return;
            
            monaco.editor.setModelLanguage(monacoEditor.getModel(), language);
            
            if (editorTabs[activeTabIndex]) {
                editorTabs[activeTabIndex].language = language;
            }
            
            document.getElementById('currentLanguage').textContent = 
                language.charAt(0).toUpperCase() + language.slice(1);
        }
        
        function detectLanguageFromFilename(filename) {
            const ext = filename.split('.').pop().toLowerCase();
            const languageMap = {
                'js': 'javascript',
                'ts': 'typescript',
                'php': 'php',
                'html': 'html',
                'css': 'css',
                'scss': 'scss',
                'json': 'json',
                'sql': 'sql',
                'md': 'markdown',
                'py': 'python',
                'java': 'java',
                'cpp': 'cpp',
                'c': 'c'
            };
            return languageMap[ext] || 'plaintext';
        }
        
        function getFileIcon(filename) {
            const ext = filename.split('.').pop().toLowerCase();
            const iconMap = {
                'js': 'fa-js-square',
                'ts': 'fa-file-code',
                'php': 'fa-file-code',
                'html': 'fa-file-code',
                'css': 'fa-css3-alt',
                'json': 'fa-file-alt',
                'sql': 'fa-database',
                'md': 'fa-markdown',
                'py': 'fa-python',
                'java': 'fa-java'
            };
            return iconMap[ext] || 'fa-file-alt';
        }
        
        function updateTabsDisplay() {
            const tabsContainer = document.getElementById('editorTabs');
            if (!tabsContainer) return;
            
            tabsContainer.innerHTML = editorTabs.map((tab, index) => `
                <div class="editor-tab ${index === activeTabIndex ? 'active' : ''}" data-index="${index}">
                    <i class="fas ${getFileIcon(tab.filename)}"></i>
                    <span>${tab.filename}</span>
                    ${tab.modified ? '<span style="color: #ff9800;">●</span>' : ''}
                    <button class="tab-close" onclick="closeTab(${index})">&times;</button>
                </div>
            `).join('');
            
            // Event listeners pour les onglets
            tabsContainer.querySelectorAll('.editor-tab').forEach((tab, index) => {
                tab.addEventListener('click', (e) => {
                    if (!e.target.classList.contains('tab-close')) {
                        switchToTab(index);
                    }
                });
            });
        }
        
        function switchToTab(index) {
            if (index < 0 || index >= editorTabs.length) return;
            
            // Sauvegarder le contenu de l'onglet actuel
            if (editorTabs[activeTabIndex]) {
                editorTabs[activeTabIndex].content = monacoEditor.getValue();
            }
            
            // Changer vers le nouvel onglet
            activeTabIndex = index;
            const tab = editorTabs[activeTabIndex];
            
            // Mettre à jour l'éditeur
            monaco.editor.setModelLanguage(monacoEditor.getModel(), tab.language);
            monacoEditor.setValue(tab.content);
            
            // Mettre à jour l'interface
            updateTabsDisplay();
            updateLanguageSelect(tab.language);
        }
        
        function closeTab(index) {
            if (editorTabs.length <= 1) {
                showAPIMessage('Impossible de fermer le dernier onglet', 'warning');
                return;
            }
            
            const tab = editorTabs[index];
            
            if (tab.modified) {
                if (!confirm(`Le fichier ${tab.filename} a été modifié. Fermer sans sauvegarder ?`)) {
                    return;
                }
            }
            
            editorTabs.splice(index, 1);
            
            if (activeTabIndex >= editorTabs.length) {
                activeTabIndex = editorTabs.length - 1;
            } else if (activeTabIndex > index) {
                activeTabIndex--;
            }
            
            // Mettre à jour l'éditeur avec l'onglet actif
            const activeTab = editorTabs[activeTabIndex];
            monaco.editor.setModelLanguage(monacoEditor.getModel(), activeTab.language);
            monacoEditor.setValue(activeTab.content);
            
            updateTabsDisplay();
            updateLanguageSelect(activeTab.language);
        }
        
        function markTabAsModified(index) {
            if (editorTabs[index]) {
                editorTabs[index].modified = true;
                updateTabsDisplay();
            }
        }
        
        function updateLanguageSelect(language) {
            const select = document.getElementById('languageSelect');
            if (select) {
                select.value = language;
            }
        }
        
        // Fonction pour rafraîchir l'arbre des fichiers pour un dossier spécifique
        async function loadFileTreeForDirectory(directory = currentWorkingDirectory) {
            const fileTree = document.getElementById('fileTree');
            if (!fileTree) return;
            
            try {
                const response = await fetch(`/api/files/list?dir=${encodeURIComponent(directory)}`, {
                    headers: {
                        'X-API-Key': await getAuthToken() || 'development'
                    }
                });
                
                if (response.ok) {
                    const files = await response.json();
                    
                    // Afficher les fichiers du dossier courant
                    fileTree.innerHTML = files.map(file => {
                        const icon = file.type === 'directory' ? 'fas fa-folder' : 'fas fa-file-alt';
                        const color = file.type === 'directory' ? 'text-primary' : '';
                        return `
                            <div class="file-item" style="padding: 0.25rem; cursor: pointer; border-radius: 4px; margin: 2px 0;" 
                                 onclick="handleFileClick('${file.path}', '${file.type}')">
                                <i class="${icon} ${color}"></i> ${file.name}
                            </div>
                        `;
                    }).join('');
                } else {
                    fileTree.innerHTML = '<div style="color: var(--muted-foreground);">Erreur de chargement</div>';
                }
            } catch (error) {
                console.error('Erreur chargement arbre:', error);
                fileTree.innerHTML = '<div style="color: var(--muted-foreground);">Erreur de connexion</div>';
            }
        }
        
        // Fonction originale pour compatibilité
        async function loadFileTree() {
            return await loadFileTreeForDirectory(currentWorkingDirectory);
        }
        
        // Notifier toutes les vues du changement de dossier
        async function notifyViewsOfDirectoryChange(newDirectory) {
            // Mettre à jour l'éditeur si ouvert
            if (window.monacoEditor) {
                console.log('🔄 Mise à jour Editor pour dossier:', newDirectory);
                // L'éditeur utilisera currentWorkingDirectory pour les prochains fichiers
            }
            
            // Mettre à jour la base de données si nécessaire
            const dbSection = document.querySelector('[data-tab="database"]');
            if (dbSection && dbSection.classList.contains('active')) {
                console.log('🔄 Mise à jour Database pour dossier:', newDirectory);
                // La base SQLite sera recherchée dans le nouveau dossier
            }
            
            // Autres vues...
            console.log('📁 Toutes les vues notifiées du changement vers:', newDirectory);
        }
        
        // Gestionnaire de clic sur fichier/dossier
        function handleFileClick(filePath, fileType) {
            if (fileType === 'directory') {
                // Construire le chemin relatif pour navigation
                const relativePath = buildRelativePath(filePath);
                console.log('📁 Navigation vers dossier:', filePath, '→', relativePath);
                changeProjectFolder(relativePath);
            } else {
                // Si c'est un fichier, l'ouvrir
                openFile(filePath);
            }
        }
        
        // Construire un chemin relatif depuis le dossier de travail actuel
        function buildRelativePath(fullPath) {
            // Extraire juste le nom du dossier depuis le chemin complet retourné par l'API
            const pathParts = fullPath.split('/');
            const folderName = pathParts[pathParts.length - 1];
            
            // Si on est à la racine, utiliser juste le nom du dossier
            if (currentWorkingDirectory === '.') {
                return folderName;
            }
            
            // Sinon, construire le chemin relatif
            return `${currentWorkingDirectory}/${folderName}`;
        }
        
        // Version obsolète pour compatibilité (utilisée plus bas)
        async function loadFileTreeObsolete() {
            const fileTree = document.getElementById('fileTree');
            if (!fileTree) return;
            
            try {
                const response = await fetch('/api/files/tree', {
                    headers: {
                        'X-API-Key': await getAuthToken() || 'development'
                    }
                });
                
                if (response.ok) {
                    const tree = await response.json();
                    renderFileTree(tree);
                } else {
                    fileTree.innerHTML = `
                        <div style="color: var(--muted-foreground); text-align: center; padding: 2rem;">
                            <i class="fas fa-exclamation-triangle"></i><br>
                            Impossible de charger l'arbre des fichiers
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Erreur chargement arbre fichiers:', error);
                fileTree.innerHTML = `
                    <div style="color: var(--muted-foreground); text-align: center; padding: 2rem;">
                        <i class="fas fa-wifi"></i><br>
                        Mode offline
                    </div>
                `;
            }
        }
        
        function renderFileTree(tree) {
            const fileTree = document.getElementById('fileTree');
            if (!fileTree) return;
            
            fileTree.innerHTML = renderTreeItems(tree.items || []);
        }
        
        function renderTreeItems(items) {
            return items.map(item => {
                if (item.type === 'directory') {
                    return `
                        <div class="file-item folder-item" onclick="toggleFolder(this)">
                            <i class="fas fa-folder"></i>
                            <span>${item.name}</span>
                        </div>
                        <div style="margin-left: 1rem; display: none;">
                            ${renderTreeItems(item.children || [])}
                        </div>
                    `;
                } else {
                    return `
                        <div class="file-item" onclick="openFile('${item.path}')">
                            <i class="fas ${getFileIcon(item.name)}"></i>
                            <span>${item.name}</span>
                        </div>
                    `;
                }
            }).join('');
        }
        
        function toggleFolder(element) {
            const nextSibling = element.nextElementSibling;
            if (nextSibling) {
                const isHidden = nextSibling.style.display === 'none';
                nextSibling.style.display = isHidden ? 'block' : 'none';
                
                const icon = element.querySelector('i');
                icon.className = isHidden ? 'fas fa-folder-open' : 'fas fa-folder';
            }
        }
    </script>
</body>
</html>